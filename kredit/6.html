<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kredit İdarəetmə Sistemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* CSS KODLARI BURADA BAŞLAYIR */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --danger-color: #d0021b;
            --success-color: #7ed321;
            --info-color: #4abde2;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --background-color: #f4f7f6;
            --text-color: #333;
            --border-color: #ddd;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sol Menyu (Sidebar) */
        .sidebar {
            width: 260px;
            background-color: var(--dark-color);
            color: var(--light-color);
            padding: 20px 0;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 0 15px;
        }

        .sidebar-header h3 {
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
            flex-grow: 1;
        }

        .nav-item a {
            display: block;
            padding: 15px 25px;
            color: var(--light-color);
            text-decoration: none;
            transition: background-color 0.3s, padding-left 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item.active a, .nav-item a:hover {
            background-color: var(--primary-color);
            border-left-color: var(--secondary-color);
        }

        .nav-item i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        /* Əsas Məzmun */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .main-header h1 {
            margin-bottom: 0;
        }
        
        .main-header h2 {
             margin-bottom: 0;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2 {
            color: var(--dark-color);
            margin-bottom: 20px;
        }

        h1 i, h2 i {
            color: var(--primary-color);
        }
        
        /* Dashboard Kartları */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
        }
        .card .icon {
            font-size: 2.5rem;
            margin-right: 20px;
            padding: 15px;
            border-radius: 50%;
            color: #fff;
        }
        .card.card-customers .icon { background-color: var(--primary-color); }
        .card.card-debt .icon { background-color: var(--danger-color); }
        .card.card-overdue .icon { background-color: var(--secondary-color); }
        .card.card-paid .icon { background-color: var(--success-color); }

        .card .info h3 { font-size: 2rem; color: var(--dark-color); }
        .card .info p { font-size: 0.9rem; color: #777; }

        /* Formalar */
        form {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .form-section-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-row.form-row-condensed {
             grid-template-columns: 2fr 1fr 1.2fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .input-group select {
            flex: 0 0 80px;
        }
        .input-group input {
            flex: 1;
        }


        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fff;
        }
        
        .form-group input:read-only {
            background-color: #f1f1f1;
            cursor: not-allowed;
            font-weight: bold;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
        }

        .submit-btn {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 10px;
        }

        .submit-btn:hover {
            background-color: #3a7ac8;
            transform: translateY(-2px);
        }
        
        .export-btn {
            background-color: var(--success-color);
        }
        .export-btn:hover {
            background-color: #69b31c;
        }

        /* Cədvəl */
        #searchBox {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
        }
        .table-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        #tarixceCedveli th, #tarixceCedveli td {
            padding: 8px; /* Daha yığcam olması üçün padding azaldıldı */
            font-size: 14px;
            text-align: center;
        }


        thead {
            background-color: #f8f9fa;
        }

        th {
            font-weight: 600;
            color: var(--dark-color);
            cursor: pointer;
            user-select: none;
        }
        th .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
        }
        th.sorted .sort-icon {
            opacity: 1;
        }


        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-gecikir { background-color: var(--danger-color); }
        .status-bugun { background-color: var(--secondary-color); }
        .status-yaxinlasir { background-color: var(--success-color); }
        .status-normal { background-color: #ccc; }


        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: #fff;
            margin: 2px;
            font-size: 13px;
            transition: opacity 0.3s;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .pay-btn { background-color: var(--primary-color); }
        .edit-btn { background-color: var(--secondary-color); }
        .delete-btn { background-color: var(--danger-color); }
        .details-btn { background-color: var(--info-color); }
        .view-details-btn { background-color: #6c757d; }
        .print-receipt-btn { background-color: var(--success-color); }


        /* Modal Pəncərələr */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }

        /* ÇEK MODALINI ÜSTƏ ÇIXARTMAQ ÜÇÜN DƏYİŞİKLİK */
        #cekModal {
            z-index: 1050;
        }
        
        /* TƏSDİQ MODALINI ÜSTƏ ÇIXARTMAQ ÜÇÜN DƏYİŞİKLİK */
        #confirmModal {
            z-index: 1060; 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            position: relative;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            animation: slideIn 0.4s;
        }
        
        .modal-content.modal-sm { max-width: 500px; }
        .modal-content.modal-lg { max-width: 800px; }
        .modal-content.modal-confirm { max-width: 400px; text-align: center; }


        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }


        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
        }
        
        /* Details Modal Styles */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 25px;
        }
        .details-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .details-item strong {
            color: #555;
            display: block;
            font-size: 13px;
            margin-bottom: 2px;
        }
        .details-item span {
            font-size: 16px;
            color: #333;
        }

        /* Çek və Müqavilə stilləri */
        .printable-content {
            border: 1px dashed #333;
            padding: 20px;
            margin-bottom: 20px;
        }
        .printable-content h2 { text-align: center; margin-bottom: 15px; }
        .printable-content p { margin-bottom: 10px; font-size: 16px; }
        .printable-content hr { margin: 15px 0; }
        
        #muqavileBody h3 {
            margin-top: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        #muqavileBody .muqavile-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        #muqavileBody .muqavile-row strong {
            color: #555;
        }
        #qrafikCedveli {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        #qrafikCedveli th, #qrafikCedveli td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        #qrafikCedveli thead {
             background-color: #f2f2f2;
        }

        .modal-actions {
            text-align: right;
            margin-top: 20px;
        }
        .modal-actions .submit-btn { margin-left: 10px; }

        /* YENİ TƏSDİQ PƏNCƏRƏSİ ÜÇÜN STİLLƏR */
        #confirmModal .modal-content {
            padding-top: 40px;
        }
        #confirmModal .confirm-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -70px auto 20px;
            box-shadow: 0 4px 10px rgba(245, 166, 35, 0.4);
        }
        #confirmModal h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }
        #confirmModal p {
            margin-bottom: 25px;
            font-size: 16px;
            color: #666;
        }
        #confirmModal .modal-actions {
            justify-content: center;
            display: flex;
            gap: 15px;
        }
        #confirmModal .confirm-btn-yes {
            background-color: var(--success-color);
        }
        #confirmModal .confirm-btn-no {
            background-color: var(--danger-color);
        }

        .paid-row {
            background-color: #e8f5e9; /* Yaşıl rəng tonu */
        }
        .partially-paid-row {
            background-color: #fffde7; /* Sarı rəng tonu */
        }


        @media print {
            body * { visibility: hidden; }
            .printable-modal, .printable-modal *, .printable-content, .printable-content * { 
                visibility: visible; 
            }
            .printable-modal { 
                position: absolute; left: 0; top: 0; width: 100%; height: 100%; 
                margin: 0; padding: 0; background: none; overflow: visible !important;
            }
            .modal-content { 
                box-shadow: none; border: none; margin: 0; max-width: 100%; padding: 5px;
            }
            .modal-actions, .close-btn { display: none; }
            
            /* Müqavilə cədvəlini çap üçün yığcamlaşdırmaq */
            #muqavileBody, #muqavileBody p { font-size: 10pt; line-height: 1.4; }
            #muqavileBody h2 { font-size: 14pt; }
            #muqavileBody h3 { font-size: 11pt; margin-top: 10px; }
            #qrafikCedveli th, #qrafikCedveli td { padding: 4px; font-size: 9pt; }
        }
        /* CSS KODLARI BURADA BİTİR */
    </style>
</head>
<body>

    <div class="container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-cash-register"></i> Kredit Sistemi</h3>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-target="idarə-paneli-sehifesi"><a href="#"><i class="fas fa-tachometer-alt"></i> İdarə Paneli</a></li>
                <li class="nav-item" data-target="yeni-kredit-sehifesi"><a href="#"><i class="fas fa-plus-circle"></i> Yeni Kredit</a></li>
                <li class="nav-item" data-target="musteri-bazasi-sehifesi"><a href="#"><i class="fas fa-users"></i> Müştəri Bazası</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <section id="idarə-paneli-sehifesi" class="page active">
                <div class="main-header"><h1><i class="fas fa-tachometer-alt"></i> İdarə Paneli</h1></div>
                 <div class="dashboard-cards">
                    <div class="card card-customers"><div class="icon"><i class="fas fa-users"></i></div><div class="info"><h3 id="total-customers">0</h3><p>Aktiv Müştəri</p></div></div>
                    <div class="card card-debt"><div class="icon"><i class="fas fa-wallet"></i></div><div class="info"><h3 id="total-debt">0 AZN</h3><p>Ümumi Qalıq Borc</p></div></div>
                    <div class="card card-overdue"><div class="icon"><i class="fas fa-exclamation-triangle"></i></div><div class="info"><h3 id="overdue-payments">0</h3><p>Gecikmədə olan</p></div></div>
                    <div class="card card-paid"><div class="icon"><i class="fas fa-check-circle"></i></div><div class="info"><h3 id="paid-this-month">0 AZN</h3><p>Bu Ay Ödənilib</p></div></div>
                </div>
            </section>
            
            <section id="yeni-kredit-sehifesi" class="page">
                <div class="main-header"><h1><i class="fas fa-file-invoice-dollar"></i> Yeni Kredit Müraciəti</h1></div>
                <form id="kreditFormu">
                    <h3 class="form-section-title">Müştəri Məlumatları</h3>
                    <div class="form-row form-row-condensed">
                        <div class="form-group"><label for="adSoyadAta"><i class="fas fa-user"></i> Ad, Soyad, Ata adı</label><input type="text" id="adSoyadAta" required></div>
                        <div class="form-group"><label for="finKod"><i class="fas fa-id-card"></i> FİN Kod</label><input type="text" id="finKod" required minlength="7" maxlength="7"></div>
                        <div class="form-group">
                            <label for="vesiqeSeria">Vəsiqə Seriya və Nömrəsi</label>
                            <div class="input-group">
                                <select id="vesiqeSeria"><option value="AZE">AZE</option><option value="AA">AA</option></select>
                                <input type="text" id="vesiqeNomre" class="numeric-input" required pattern="\d{7}" maxlength="7" placeholder="1234567">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mobil1-nomre"><i class="fas fa-mobile-alt"></i> Əsas Mobil Nömrə</label>
                            <div class="input-group">
                                <select id="mobil1-prefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select>
                                <input type="tel" id="mobil1-nomre" class="numeric-input" required pattern="\d{7}" maxlength="7" placeholder="1234567">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mobil2-nomre"><i class="fas fa-phone"></i> Əlavə Nömrə 1</label>
                             <div class="input-group">
                                <select id="mobil2-prefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select>
                                <input type="tel" id="mobil2-nomre" class="numeric-input" pattern="\d{7}" maxlength="7" placeholder="1234567">
                            </div>
                        </div>
                         <div class="form-group">
                            <label for="mobil3-nomre"><i class="fas fa-phone"></i> Əlavə Nömrə 2</label>
                             <div class="input-group">
                                <select id="mobil3-prefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select>
                                <input type="tel" id="mobil3-nomre" class="numeric-input" pattern="\d{7}" maxlength="7" placeholder="1234567">
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="form-section-title">Kredit Məlumatları</h3>
                     <div class="form-row">
                        <div class="form-group"><label for="mehsulAdi"><i class="fas fa-box"></i> Məhsulun Adı</label><input type="text" id="mehsulAdi" required></div>
                        <div class="form-group">
                            <label for="mehsulKateqoriya"><i class="fas fa-tags"></i> Kateqoriya</label>
                            <select id="mehsulKateqoriya" required>
                                <option value="" disabled selected>Kateqoriya seçin</option>
                                <option value="Mobil telefon">Mobil telefon</option>
                                <option value="Böyük məişət texnikası">Böyük məişət texnikası</option>
                                <option value="Kiçik məişət texnikası">Kiçik məişət texnikası</option>
                                <option value="Aksesuar">Aksesuar</option>
                                <option value="Digər">Digər</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="nagdQiymet"><i class="fas fa-money-bill-wave"></i> Nağd Qiyməti (AZN)</label><input type="number" id="nagdQiymet" required min="0"></div>
                         <div class="form-group"><label for="kreditMuddeti"><i class="fas fa-calendar-alt"></i> Kredit Müddəti (Ay)</label>
                             <select id="kreditMuddeti">
                                <option value="3">3 Ay (+8%)</option>
                                <option value="6">6 Ay (+8%)</option>
                                <option value="9">9 Ay (+8%)</option>
                                <option value="12" selected>12 Ay (+15%)</option>
                                <option value="18">18 Ay (+20%)</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="ilkinOdenis"><i class="fas fa-hand-holding-usd"></i> İlkin Ödəniş (AZN)</label><input type="number" id="ilkinOdenis" value="0" min="0"></div>
                    </div>
                     <div class="form-row" style="background: #f8f9fa; padding: 15px; border-radius: 5px; align-items: center;">
                        <div class="form-group"><label for="kreditQiymeti"><i class="fas fa-credit-card"></i> Ümumi Kredit Məbləği (AZN)</label><input type="text" id="kreditQiymeti" readonly></div>
                        <div class="form-group"><label for="ayliqOdenis"><i class="fas fa-calendar-check"></i> Aylıq Ödəniş (AZN)</label><input type="text" id="ayliqOdenis" readonly></div>
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-file-signature"></i> Müqaviləyə Bax</button>
                </form>
            </section>

            <section id="musteri-bazasi-sehifesi" class="page">
                <div class="main-header">
                    <h1><i class="fas fa-database"></i> Müştəri Bazası</h1>
                    <button id="exportCsvBtn" class="submit-btn export-btn"><i class="fas fa-file-csv"></i> CSV İxrac Et</button>
                </div>
                <input type="text" id="searchBox" placeholder="Ada, soyada və ya FİN koda görə axtar...">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-sort="status">Status</th>
                                <th data-sort="adSoyadAta">Ad Soyad Ata adı</th>
                                <th data-sort="ayliqOdenis">Aylıq Ödəniş</th>
                                <th data-sort="qaliqBorc">Qalıq Borc</th>
                                <th data-sort="qaliqAylar">Qalıq Ay</th>
                                <th data-sort="novbetiOdenisTarixi">Növbəti Ödəniş</th>
                                <th>Əməliyyatlar</th>
                            </tr>
                        </thead>
                        <tbody id="musteriCedveli"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
    
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeDetailsModal">&times;</span>
            <div class="main-header" style="margin-bottom: 15px;">
                 <h2 style="margin-bottom: 0;"><i class="fas fa-user-tag"></i> Müştəri Məlumatları</h2>
                 <button id="viewScheduleBtn" class="submit-btn" style="margin-top: 0;"><i class="fas fa-calendar-alt"></i> Ödəniş Cədvəli</button>
            </div>
            <h3 class="form-section-title">Şəxsi Məlumatlar</h3>
            <div class="details-grid">
                <div class="details-item"><strong>Ad, Soyad, Ata adı</strong><span id="detailsAdSoyad"></span></div>
                <div class="details-item"><strong>FİN Kod</strong><span id="detailsFinKod"></span></div>
                <div class="details-item"><strong>Vəsiqə Seriya və Nömrəsi</strong><span id="detailsVesiqe"></span></div>
                <div class="details-item"><strong>Mobil Nömrələr</strong><span id="detailsNomreler"></span></div>
            </div>
            <h3 class="form-section-title">Kredit Məlumatları</h3>
            <div class="details-grid">
                <div class="details-item"><strong>Məhsul Adı</strong><span id="detailsMehsulAd"></span></div>
                <div class="details-item"><strong>Kateqoriya</strong><span id="detailsKateqoriya"></span></div>
                <div class="details-item"><strong>Kreditlə Qiyməti</strong><span id="detailsKreditQiymet"></span></div>
                <div class="details-item"><strong>İlkin Ödəniş</strong><span id="detailsIlkinOdenis"></span></div>
                <div class="details-item"><strong>Kredit Müddəti</strong><span id="detailsKreditMuddet"></span></div>
                <div class="details-item"><strong>Aylıq Ödəniş</strong><span id="detailsAyliqOdenis"></span></div>
            </div>
        </div>
    </div>

    <div id="odenisModal" class="modal"><div class="modal-content modal-sm"><span class="close-btn" id="closeOdenisModal">&times;</span><h2><i class="fas fa-wallet"></i> Ödəniş Et</h2><form id="odenisFormu"><p><strong>Müştəri:</strong> <span id="modalMusteriAdi"></span></p><p><strong>Bu Ay Ödənilməlidir:</strong> <span id="modalAyliqOdenis"></span> AZN</p><input type="hidden" id="modalMusteriId"><input type="hidden" id="modalOdenisAyIndex"><div class="form-group"><label for="odenilenMebleg">Ödənilən Məbləğ (AZN)</label><input type="number" id="odenilenMebleg" step="0.01" required></div><div class="form-group"><label for="odenisUsulu">Ödəniş Üsulu</label><select id="odenisUsulu"><option value="Nağd">Nağd</option><option value="Kart">Kart ilə</option></select></div><button type="submit" class="submit-btn"><i class="fas fa-dollar-sign"></i> Ödənişi Təsdiqlə</button></form></div></div>
    
    <div id="cekModal" class="modal printable-modal"><div class="modal-content modal-sm" id="cekContent"><span class="close-btn" id="closeCekModal">&times;</span><div id="cekBody" class="printable-content"><h2>ÖDƏNİŞ QƏBZİ</h2><p><strong>Qəbz ID:</strong> <span id="cekId"></span></p><p><strong>Tarix:</strong> <span id="cekTarix"></span></p><hr><p><strong>Müştəri:</strong> <span id="cekMusteriAdi"></span></p><p><strong>Ödənilən Məbləğ:</strong> <span id="cekOdenenMebleg"></span> AZN</p><p><strong>Ödəniş Üsulu:</strong> <span id="cekOdenisUsulu"></span></p><hr><p><strong>Ümumi Qalıq Borc:</strong> <span id="cekQaliqBorc"></span> AZN</p></div><div class="modal-actions"><button id="printCekBtn" class="submit-btn"><i class="fas fa-print"></i> Çap Et</button></div></div></div>
    
    <div id="editModal" class="modal"><div class="modal-content modal-lg"><span class="close-btn" id="closeEditModal">&times;</span><h2><i class="fas fa-edit"></i> Məlumatlara Düzəliş Et</h2><form id="editMusteriFormu"><input type="hidden" id="editMusteriId"><h3 class="form-section-title">Müştəri Məlumatları</h3><div class="form-row"><div class="form-group"><label for="editAdSoyadAta">Ad Soyad Ata adı</label><input type="text" id="editAdSoyadAta" required></div><div class="form-group"><label for="editFinKod">FİN Kod</label><input type="text" id="editFinKod" required minlength="7" maxlength="7"></div><div class="form-group"><label for="editVesiqeSeria">Vəsiqə Seriya və Nömrəsi</label><div class="input-group"><select id="editVesiqeSeria"><option value="AZE">AZE</option><option value="AA">AA</option></select><input type="text" id="editVesiqeNomre" class="numeric-input" required pattern="\d{7}" maxlength="7"></div></div></div><div class="form-row"><div class="form-group"><label for="editMobil1">Əsas Mobil Nömrə</label><input type="tel" id="editMobil1" required></div><div class="form-group"><label for="editMobil2">Əlavə Nömrə 1</label><input type="tel" id="editMobil2"></div><div class="form-group"><label for="editMobil3">Əlavə Nömrə 2</label><input type="tel" id="editMobil3"></div></div><h3 class="form-section-title">Kredit Məlumatları (Dəyişdirilə bilməz)</h3><div class="form-row"><div class="form-group"><label for="editMehsulAdi">Məhsulun Adı</label><input type="text" id="editMehsulAdi" readonly></div><div class="form-group"><label for="editMehsulKateqoriya">Kateqoriya</label><input type="text" id="editMehsulKateqoriya" readonly></div></div><button type="submit" class="submit-btn"><i class="fas fa-save"></i> Dəyişiklikləri Yadda Saxla</button></form></div></div>

    <div id="muqavileModal" class="modal printable-modal"><div class="modal-content modal-lg"><span class="close-btn" id="closeMuqavileModal">&times;</span><div id="muqavileBody" class="printable-content"><h2>Alqı-Satqı və Kredit Müqaviləsi</h2><p><strong>Tarix:</strong> <span id="muqavileTarix"></span></p><hr><h3>Tərəflər</h3><p><strong>Satıcı:</strong> "Mağaza Adı" MMC</p><p><strong>Alıcı:</strong> <span id="muqavileMusteriAdi"></span></p><div class="muqavile-row"><p><strong>FİN Kod:</strong> <span id="muqavileFinKod"></span></p><p><strong>Vəsiqə:</strong> <span id="muqavileVesiqe"></span></p></div><hr><h3>Müqavilənin Predmeti</h3><div class="muqavile-row"><span><strong>Məhsul:</strong> <span id="muqavileMehsul"></span></span><span><strong>Kateqoriya:</strong> <span id="muqavileKateqoriya"></span></span></div><hr><h3>Kredit Şərtləri</h3><div class="muqavile-row"><span><strong>Nağd Qiymət:</strong> <span id="muqavileNagdQiymet"></span> AZN</span><span><strong>Kreditlə Qiymət:</strong> <span id="muqavileKreditQiymeti"></span> AZN</span></div><div class="muqavile-row"><span><strong>İlkin Ödəniş:</strong> <span id="muqavileIlkinOdenis"></span> AZN</span><span><strong>Kredit Müddəti:</strong> <span id="muqavileKreditMuddeti"></span> ay</span></div><div class="muqavile-row"><span><strong>Aylıq Ödəniş:</strong> <span id="muqavileAyliqOdenis"></span> AZN</span><span><strong>İlk Ödəniş Tarixi:</strong> <span id="muqavileIlkOdenisTarixi"></span></span></div><hr><h3>Ödəniş Cədvəli</h3><table id="qrafikCedveli"><thead><tr><th>Ay</th><th>Ödəniş Tarixi</th><th>Məbləğ (AZN)</th><th>Status</th></tr></thead><tbody id="muqavileQrafikBody"></tbody></table><br><div class="muqavile-row" style="margin-top: 40px;"><p><strong>Satıcı: _______________</strong></p><p><strong>Alıcı: _______________</strong></p></div></div><div class="modal-actions"><button id="printMuqavileBtn" class="submit-btn export-btn"><i class="fas fa-print"></i> Çap Et</button><button id="confirmMuqavileBtn" class="submit-btn"><i class="fas fa-check"></i> Təsdiqlə və Yadda Saxla</button></div></div></div>
    
    <div id="odenisTarixcesiModal" class="modal"><div class="modal-content modal-lg"><span class="close-btn" id="closeTarixceModal">&times;</span><h2><i class="fas fa-history"></i> Ödəniş Qrafiki</h2><p><strong>Müştəri:</strong> <span id="tarixceMusteriAdi"></span></p><div class="table-container"><table id="tarixceCedveli"><thead><tr><th>№</th><th>Ödəniş Tarixi</th><th>Aylıq Məbləğ</th><th>Ödənilib</th><th>Qalıq</th><th>Status</th></tr></thead><tbody id="tarixceCedveliBody"></tbody></table></div></div></div>
    
    <div id="confirmModal" class="modal">
        <div class="modal-content modal-confirm">
            <div class="confirm-icon"><i class="fas fa-question"></i></div>
            <h3 id="confirmTitle">Təsdiq</h3>
            <p id="confirmText">Bu əməliyyatı təsdiqləyirsiniz?</p>
            <div class="modal-actions">
                <button id="confirmBtnYes" class="submit-btn confirm-btn-yes"><i class="fas fa-check"></i> Bəli</button>
                <button id="confirmBtnNo" class="submit-btn confirm-btn-no"><i class="fas fa-times"></i> Xeyr</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // === ELEMENT SEÇİMLƏRİ ===
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        const kreditFormu = document.getElementById('kreditFormu');
        const musteriCedveli = document.getElementById('musteriCedveli');
        const searchBox = document.getElementById('searchBox');
        const tableHeaders = document.querySelectorAll('#musteri-bazasi-sehifesi thead th');
        const exportCsvBtn = document.getElementById('exportCsvBtn');

        const nagdQiymetInput = document.getElementById('nagdQiymet');
        const kreditMuddetiSelect = document.getElementById('kreditMuddeti');
        const ilkinOdenisInput = document.getElementById('ilkinOdenis');
        const kreditQiymetiInput = document.getElementById('kreditQiymeti');
        const ayliqOdenisInput = document.getElementById('ayliqOdenis');

        // Modal Pəncərə Elementləri
        const odenisModal = document.getElementById('odenisModal');
        const cekModal = document.getElementById('cekModal');
        const editModal = document.getElementById('editModal');
        const muqavileModal = document.getElementById('muqavileModal');
        const odenisTarixcesiModal = document.getElementById('odenisTarixcesiModal');
        const detailsModal = document.getElementById('detailsModal');
        const confirmModal = document.getElementById('confirmModal'); 

        const closeOdenisModal = document.getElementById('closeOdenisModal');
        const closeCekModal = document.getElementById('closeCekModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const closeMuqavileModal = document.getElementById('closeMuqavileModal');
        const closeTarixceModal = document.getElementById('closeTarixceModal');
        const closeDetailsModal = document.getElementById('closeDetailsModal');

        const odenisFormu = document.getElementById('odenisFormu');
        const editMusteriFormu = document.getElementById('editMusteriFormu');
        const printCekBtn = document.getElementById('printCekBtn');
        const printMuqavileBtn = document.getElementById('printMuqavileBtn');
        const confirmMuqavileBtn = document.getElementById('confirmMuqavileBtn');
        const confirmBtnYes = document.getElementById('confirmBtnYes'); 
        const confirmBtnNo = document.getElementById('confirmBtnNo'); 
        const viewScheduleBtn = document.getElementById('viewScheduleBtn');

        // === QLOBAL DƏYİŞƏNLƏR ===
        let musteriler = JSON.parse(localStorage.getItem('musteriler')) || [];
        let muveqqetiMusteri = null;
        let sortState = { column: 'novbetiOdenisTarixi', direction: 'asc' };
        let currentConfirmCallback = null; // Təsdiq pəncərəsi üçün callback
        let currentDetailsCustomerId = null; // Details modalında olan müştərinin ID-si
        
        const interestRates = { 3: 0.08, 6: 0.08, 9: 0.08, 12: 0.15, 18: 0.20 };

        // === HADİSƏ DİNLƏYİCİLƏRİ (EVENT LISTENERS) ===
        
        document.querySelectorAll('.numeric-input').forEach(input => {
            input.addEventListener('input', function(e) { this.value = this.value.replace(/[^0-9]/g, ''); });
        });
        
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                navItems.forEach(nav => nav.classList.remove('active'));
                pages.forEach(page => page.classList.remove('active'));
                item.classList.add('active');
                const targetId = item.getAttribute('data-target');
                document.getElementById(targetId).classList.add('active');
            });
        });

        [nagdQiymetInput, kreditMuddetiSelect, ilkinOdenisInput].forEach(el => {
            el.addEventListener('input', calculateKreditDetails);
        });

        kreditFormu.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const telefonNomreleri = [];
            if (document.getElementById('mobil1-nomre').value) telefonNomreleri.push(document.getElementById('mobil1-prefix').value + document.getElementById('mobil1-nomre').value);
            if (document.getElementById('mobil2-nomre').value) telefonNomreleri.push(document.getElementById('mobil2-prefix').value + document.getElementById('mobil2-nomre').value);
            if (document.getElementById('mobil3-nomre').value) telefonNomreleri.push(document.getElementById('mobil3-prefix').value + document.getElementById('mobil3-nomre').value);
            
            const ayliqOdenis = parseFloat(ayliqOdenisInput.value);
            const kreditMuddeti = parseInt(kreditMuddetiSelect.value);
            
            const odenisQrafiki = [];
            let ilkOdenisTarixi = new Date();
            ilkOdenisTarixi.setMonth(ilkOdenisTarixi.getMonth() + 1);

            for(let i=0; i < kreditMuddeti; i++){
                odenisQrafiki.push({
                    ay: i + 1,
                    tarix: new Date(ilkOdenisTarixi).toISOString().split('T')[0],
                    odenmeli: ayliqOdenis,
                    odenmis: 0,
                    odenisler: []
                });
                ilkOdenisTarixi.setMonth(ilkOdenisTarixi.getMonth() + 1);
            }

            muveqqetiMusteri = {
                id: Date.now(),
                adSoyadAta: document.getElementById('adSoyadAta').value,
                finKod: document.getElementById('finKod').value.toUpperCase(),
                vesiqeSeria: document.getElementById('vesiqeSeria').value + ' ' + document.getElementById('vesiqeNomre').value,
                nomreler: telefonNomreleri,
                mehsulAdi: document.getElementById('mehsulAdi').value,
                mehsulKateqoriya: document.getElementById('mehsulKateqoriya').value,
                nagdQiymet: parseFloat(nagdQiymetInput.value),
                kreditQiymeti: parseFloat(kreditQiymetiInput.value),
                ilkinOdenis: parseFloat(ilkinOdenisInput.value) || 0,
                kreditMuddeti: kreditMuddeti,
                odenisQrafiki: odenisQrafiki
            };
            openMuqavileModal(muveqqetiMusteri);
        });
        
        confirmMuqavileBtn.addEventListener('click', () => {
            if (muveqqetiMusteri) {
                musteriler.push(muveqqetiMusteri);
                saveAndRender();
                kreditFormu.reset();
                calculateKreditDetails();
                muqavileModal.style.display = 'none';
                alert('Yeni kredit uğurla əlavə edildi!');
                muveqqetiMusteri = null;
            }
        });

        editMusteriFormu.addEventListener('submit', (e) => {
            e.preventDefault();
            
            showConfirm('Dəyişiklikləri Yadda Saxla', 'Müştəri məlumatlarında edilən dəyişiklikləri yadda saxlamağa əminsiniz?', () => {
                const id = parseInt(document.getElementById('editMusteriId').value);
                const musteriIndex = musteriler.findIndex(m => m.id === id);
                
                if (musteriIndex > -1) {
                    musteriler[musteriIndex] = {
                        ...musteriler[musteriIndex],
                        adSoyadAta: document.getElementById('editAdSoyadAta').value,
                        finKod: document.getElementById('editFinKod').value.toUpperCase(),
                        vesiqeSeria: document.getElementById('editVesiqeSeria').value + ' ' + document.getElementById('editVesiqeNomre').value,
                        nomreler: [ document.getElementById('editMobil1').value, document.getElementById('editMobil2').value, document.getElementById('editMobil3').value ].filter(n => n),
                    };
                    saveAndRender();
                    editModal.style.display = 'none';
                    alert('Müştəri məlumatları uğurla yeniləndi!');
                }
            });
        });

        searchBox.addEventListener('keyup', () => renderMusteriler());
        musteriCedveli.addEventListener('click', handleTableActions);
        document.getElementById('tarixceCedveliBody').addEventListener('click', handleTarixceActions);
        tableHeaders.forEach(th => { if(th.dataset.sort) th.addEventListener('click', handleSort) });
        exportCsvBtn.addEventListener('click', exportToCSV);

        odenisFormu.addEventListener('submit', (e) => {
            e.preventDefault();
            const odenilenMebleg = parseFloat(document.getElementById('odenilenMebleg').value);
            
            if (odenilenMebleg <= 0) {
                alert("Ödəniş məbləği 0-dan böyük olmalıdır.");
                return;
            }
            
            showConfirm(
                'Ödənişi Təsdiqlə', 
                `${odenilenMebleg.toFixed(2)} AZN məbləğində ödənişi təsdiqləyirsiniz?`, 
                processPayment
            );
        });

        confirmBtnYes.addEventListener('click', () => {
            if (currentConfirmCallback) {
                currentConfirmCallback();
            }
            confirmModal.style.display = 'none';
        });

        confirmBtnNo.addEventListener('click', () => {
            confirmModal.style.display = 'none';
        });

        viewScheduleBtn.addEventListener('click', () => {
            if (currentDetailsCustomerId) {
                openOdenisTarixcesiModal(currentDetailsCustomerId);
            }
        });

        // ÖDƏNİŞİ HƏYATA KEÇİRƏN FUNKSİYA
        function processPayment() {
            const id = parseInt(document.getElementById('modalMusteriId').value);
            const musteri = musteriler.find(m => m.id === id);
            const ayIndex = parseInt(document.getElementById('modalOdenisAyIndex').value);
            const odenilenMebleg = parseFloat(document.getElementById('odenilenMebleg').value);
            const odenisUsulu = document.getElementById('odenisUsulu').value;

            const yeniOdenis = {
                id: "Q" + Date.now(),
                tarix: new Date().toISOString(),
                mebleg: odenilenMebleg,
                usul: odenisUsulu
            };

            // Ödənişi müvafiq ayın siyahısına əlavə et
            if(ayIndex >= 0 && ayIndex < musteri.odenisQrafiki.length) {
                musteri.odenisQrafiki[ayIndex].odenisler.push(yeniOdenis);
            }
            
            // Bütün qrafiki yenidən hesabla
            recalculatePaymentSchedule(id);

            saveAndRender();
            odenisModal.style.display = 'none';
            openCekModal(musteri, yeniOdenis);
            // openOdenisTarixcesiModal(id); // >> Tələbə əsasən bu sətir silindi
        }


        // Modal pəncərələri bağlamaq
        closeOdenisModal.onclick = () => odenisModal.style.display = 'none';
        closeCekModal.onclick = () => cekModal.style.display = 'none';
        closeEditModal.onclick = () => editModal.style.display = 'none';
        closeMuqavileModal.onclick = () => muqavileModal.style.display = 'none';
        closeTarixceModal.onclick = () => odenisTarixcesiModal.style.display = 'none';
        closeDetailsModal.onclick = () => detailsModal.style.display = 'none';
        
        printCekBtn.addEventListener('click', () => window.print());
        printMuqavileBtn.addEventListener('click', () => window.print());

        window.onclick = (event) => {
            const modals = [odenisModal, cekModal, editModal, muqavileModal, odenisTarixcesiModal, detailsModal, confirmModal];
            if (modals.includes(event.target)) {
                event.target.style.display = 'none';
            }
        };

        // === FUNKSİYALAR ===
        
        function showConfirm(title, text, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').textContent = text;
            currentConfirmCallback = callback;
            confirmModal.style.display = 'block';
        }
        
        // YENİ FUNKSİYA: Bütün ödəniş qrafikini yenidən hesablayır
        function recalculatePaymentSchedule(musteriId) {
            const musteri = musteriler.find(m => m.id === musteriId);
            if (!musteri) return;

            // 1. Bütün ayların ödənilmiş məbləğini sıfırla
            musteri.odenisQrafiki.forEach(ay => {
                ay.odenmis = 0;
            });

            // 2. Bütün individual ödənişləri bir siyahıya yığıb tarixə görə sırala
            const allPayments = musteri.odenisQrafiki
                .flatMap(ay => ay.odenisler)
                .sort((a, b) => new Date(a.tarix) - new Date(b.tarix));

            // 3. Hər bir ödənişi qrafik üzrə yenidən payla
            allPayments.forEach(payment => {
                let amountToDistribute = payment.mebleg;
                
                for (let i = 0; i < musteri.odenisQrafiki.length; i++) {
                    if (amountToDistribute <= 0) break;
                    
                    const ay = musteri.odenisQrafiki[i];
                    const qaliqForMonth = ay.odenmeli - ay.odenmis;

                    if (qaliqForMonth > 0) {
                        const paidForThisMonth = Math.min(amountToDistribute, qaliqForMonth);
                        ay.odenmis += paidForThisMonth;
                        amountToDistribute -= paidForThisMonth;
                    }
                }
            });
        }


        function calculateKreditDetails() {
            const nagdQiymet = parseFloat(nagdQiymetInput.value) || 0;
            const muddet = parseInt(kreditMuddetiSelect.value);
            const ilkinOdenis = parseFloat(ilkinOdenisInput.value) || 0;

            if (nagdQiymet > 0) {
                const faiz = interestRates[muddet];
                const kreditQiymeti = nagdQiymet * (1 + faiz);
                kreditQiymetiInput.value = kreditQiymeti.toFixed(2);

                const qaliqBorc = kreditQiymeti - ilkinOdenis;
                if (qaliqBorc > 0 && muddet > 0) {
                    const ayliqOdenis = qaliqBorc / muddet;
                    ayliqOdenisInput.value = ayliqOdenis.toFixed(2);
                } else {
                     ayliqOdenisInput.value = '0.00';
                }
            } else {
                kreditQiymetiInput.value = '';
                ayliqOdenisInput.value = '';
            }
        }
        
        function handleTableActions(e) {
            const target = e.target;
            const tr = target.closest('tr');
            if (!tr) return;
            
            const id = parseInt(tr.dataset.id);
            if (target.closest('.details-btn')) openOdenisTarixcesiModal(id);
            if (target.closest('.edit-btn')) openEditModal(id);
            if (target.closest('.view-details-btn')) openDetailsModal(id);
            
            if (target.closest('.delete-btn')) {
                 showConfirm('Silmə Əməliyyatı', 'Bu müştərini və bütün kredit məlumatlarını silməyə əminsiniz?', () => {
                    musteriler = musteriler.filter(m => m.id !== id);
                    saveAndRender();
                });
            }

            if (target.closest('.pay-btn')) {
                const musteri = musteriler.find(m => m.id === id);
                if (musteri) {
                    const novbetiOdenisAyIndex = musteri.odenisQrafiki.findIndex(ay => (ay.odenmeli - ay.odenmis) > 0.01);
                    if (novbetiOdenisAyIndex !== -1) {
                        openOdenisModal(id, novbetiOdenisAyIndex);
                    } else {
                        alert('Bu müştərinin aktiv borcu yoxdur.');
                    }
                }
            }
        }

        function handleTarixceActions(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const tr = target.closest('tr');
            const musteriId = parseInt(tr.dataset.musteriId);
            const ayIndex = parseInt(tr.dataset.ayIndex);
            
            if(target.classList.contains('edit-payment-btn')) {
                const odenisId = target.dataset.odenisId;
                handleEditPayment(musteriId, odenisId);
            }
            if(target.classList.contains('print-receipt-btn')) {
                const odenisId = target.dataset.odenisId;
                const musteri = musteriler.find(m => m.id === musteriId);
                const odenis = musteri.odenisQrafiki.flatMap(ay => ay.odenisler).find(o => o.id === odenisId);
                if(odenis) openCekModal(musteri, odenis);
            }
        }

        function handleEditPayment(musteriId, odenisId) {
             const musteri = musteriler.find(m => m.id === musteriId);
             let odenis, odenisAyi, odenisIndex;

             // Bütün qrafikdə həmin ödənişi tap
             for (const ay of musteri.odenisQrafiki) {
                 const index = ay.odenisler.findIndex(o => o.id === odenisId);
                 if (index !== -1) {
                     odenis = ay.odenisler[index];
                     odenisAyi = ay;
                     odenisIndex = index;
                     break;
                 }
             }

             if (!odenis) return;

             const yeniMeblegStr = prompt("Ödəniş üçün yeni məbləği daxil edin:", odenis.mebleg);
             const yeniMebleg = parseFloat(yeniMeblegStr);

             if (yeniMeblegStr !== null && !isNaN(yeniMebleg) && yeniMebleg >= 0) {
                 // Ödəniş məbləğini yenilə
                 odenis.mebleg = yeniMebleg;
                 
                 // Əgər məbləğ 0 olarsa, ödənişi siyahıdan sil
                 if (yeniMebleg === 0) {
                     odenisAyi.odenisler.splice(odenisIndex, 1);
                 }
                 
                 // Dəyişiklikdən sonra bütün qrafiki yenidən hesabla
                 recalculatePaymentSchedule(musteriId);

                 saveAndRender();
                 openOdenisTarixcesiModal(musteriId);
             } else if (yeniMeblegStr !== null) {
                 alert("Düzgün məbləğ daxil edilməyib.");
             }
        }
        
        function handleSort(e) {
            const th = e.currentTarget;
            const column = th.dataset.sort;
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }
            renderMusteriler();
        }

        function openOdenisModal(musteriId, ayIndex) {
            const musteri = musteriler.find(m => m.id === musteriId);
            const odenisAyi = musteri.odenisQrafiki[ayIndex];
            const qaliq = odenisAyi.odenmeli - odenisAyi.odenmis;

            if (!musteri || qaliq <= 0) {
                alert("Bu ay üçün borc yoxdur və ya tam ödənilib.");
                return;
            };

            document.getElementById('modalMusteriAdi').textContent = musteri.adSoyadAta;
            document.getElementById('modalAyliqOdenis').textContent = qaliq.toFixed(2);
            document.getElementById('odenilenMebleg').value = qaliq.toFixed(2);
            document.getElementById('modalMusteriId').value = musteriId;
            document.getElementById('modalOdenisAyIndex').value = ayIndex;
            odenisModal.style.display = 'block';
        }

        function openOdenisTarixcesiModal(id) {
            const musteri = musteriler.find(m => m.id === id);
            if (!musteri) return;

            document.getElementById('tarixceMusteriAdi').textContent = musteri.adSoyadAta;
            const tbody = document.getElementById('tarixceCedveliBody');
            tbody.innerHTML = '';

            musteri.odenisQrafiki.forEach((ay, index) => {
                const qaliq = ay.odenmeli - ay.odenmis;
                let statusText, statusClass;

                if (qaliq <= 0.01) {
                    statusText = "Ödənilib";
                    statusClass = "paid-row";
                } else if (ay.odenmis > 0) {
                    statusText = "Qismən Ödənilib";
                    statusClass = "partially-paid-row";
                } else {
                    statusText = getStatus(ay.tarix).statusText;
                    statusClass = '';
                }
                
                let odenisDetallari = '';
                if(ay.odenisler.length > 0){
                    odenisDetallari += '<ul style="margin: 0; padding: 0; list-style-type: none;">';
                    ay.odenisler.forEach(o => {
                        odenisDetallari += `
                            <li style="font-size: 12px; text-align: left; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                                ${new Date(o.tarix).toLocaleDateString('az-AZ')} - <b>${o.mebleg.toFixed(2)} AZN</b>
                                <button class="action-btn edit-btn edit-payment-btn" data-odenis-id="${o.id}" title="Düzəliş et" style="padding: 2px 5px; font-size: 10px; float: right; margin-left: 5px;"><i class="fas fa-edit"></i></button>
                                <button class="action-btn print-receipt-btn" data-odenis-id="${o.id}" title="Çeki çap et" style="padding: 2px 5px; font-size: 10px; float: right;"><i class="fas fa-print"></i></button>
                            </li>`;
                    });
                    odenisDetallari += '</ul>';
                } else {
                     odenisDetallari = ay.odenmis > 0 ? `${ay.odenmis.toFixed(2)} AZN (Əvvəlki ödənişdən transfer)` : '---' ;
                }

                const tr = document.createElement('tr');
                tr.className = statusClass;
                tr.dataset.musteriId = id;
                tr.dataset.ayIndex = index;
                tr.innerHTML = `
                    <td>${ay.ay}</td>
                    <td>${new Date(ay.tarix).toLocaleDateString('az-AZ')}</td>
                    <td>${ay.odenmeli.toFixed(2)}</td>
                    <td>${odenisDetallari}</td>
                    <td><b>${qaliq < 0 ? '0.00' : qaliq.toFixed(2)}</b></td>
                    <td>${statusText}</td>
                `;
                tbody.appendChild(tr);
            });
            odenisTarixcesiModal.style.display = 'block';
        }

        function openDetailsModal(id) {
            const musteri = musteriler.find(m => m.id === id);
            if (!musteri) return;
            
            currentDetailsCustomerId = id; // >> YENİ: Müştəri ID-sini qlobal dəyişəndə saxla

            document.getElementById('detailsAdSoyad').textContent = musteri.adSoyadAta;
            document.getElementById('detailsFinKod').textContent = musteri.finKod;
            document.getElementById('detailsVesiqe').textContent = musteri.vesiqeSeria;
            document.getElementById('detailsNomreler').textContent = musteri.nomreler.join(', ');
            document.getElementById('detailsMehsulAd').textContent = musteri.mehsulAdi;
            document.getElementById('detailsKateqoriya').textContent = musteri.mehsulKateqoriya;
            document.getElementById('detailsKreditQiymet').textContent = `${musteri.kreditQiymeti.toFixed(2)} AZN`;
            document.getElementById('detailsIlkinOdenis').textContent = `${musteri.ilkinOdenis.toFixed(2)} AZN`;
            document.getElementById('detailsKreditMuddet').textContent = `${musteri.kreditMuddeti} ay`;
            document.getElementById('detailsAyliqOdenis').textContent = `${musteri.odenisQrafiki[0].odenmeli.toFixed(2)} AZN`;
            
            detailsModal.style.display = 'block';
        }
        
        function openEditModal(id) {
            const musteri = musteriler.find(m => m.id === id);
            if (!musteri) return;
            
            document.getElementById('editMusteriId').value = musteri.id;
            document.getElementById('editAdSoyadAta').value = musteri.adSoyadAta;
            document.getElementById('editFinKod').value = musteri.finKod;
            const [seria, ...nomreParts] = musteri.vesiqeSeria.split(' ');
            const nomre = nomreParts.join('');
            document.getElementById('editVesiqeSeria').value = seria;
            document.getElementById('editVesiqeNomre').value = nomre || '';
            
            document.getElementById('editMobil1').value = musteri.nomreler[0] || '';
            document.getElementById('editMobil2').value = musteri.nomreler[1] || '';
            document.getElementById('editMobil3').value = musteri.nomreler[2] || '';
            
            // Kredit məlumatlarını readonly olaraq doldurmaq
            document.getElementById('editMehsulAdi').value = musteri.mehsulAdi;
            document.getElementById('editMehsulKateqoriya').value = musteri.mehsulKateqoriya;
            
            editModal.style.display = 'block';
        }

        function openCekModal(musteri, odenis) {
             const umumiQaliqBorc = getMusteriUmumiQaliqBorc(musteri);

            document.getElementById('cekId').textContent = odenis.id;
            document.getElementById('cekTarix').textContent = new Date(odenis.tarix).toLocaleString('az-AZ');
            document.getElementById('cekMusteriAdi').textContent = musteri.adSoyadAta;
            document.getElementById('cekOdenenMebleg').textContent = odenis.mebleg.toFixed(2);
            document.getElementById('cekOdenisUsulu').textContent = odenis.usul;
            document.getElementById('cekQaliqBorc').textContent = Math.max(0, umumiQaliqBorc).toFixed(2);
            cekModal.style.display = 'block';
        }
        
        function openMuqavileModal(musteri) {
            document.getElementById('muqavileTarix').textContent = new Date().toLocaleDateString('az-AZ');
            document.getElementById('muqavileMusteriAdi').textContent = musteri.adSoyadAta;
            document.getElementById('muqavileFinKod').textContent = musteri.finKod;
            document.getElementById('muqavileVesiqe').textContent = musteri.vesiqeSeria;
            document.getElementById('muqavileMehsul').textContent = musteri.mehsulAdi;
            document.getElementById('muqavileKateqoriya').textContent = musteri.mehsulKateqoriya;
            document.getElementById('muqavileNagdQiymet').textContent = musteri.nagdQiymet.toFixed(2);
            document.getElementById('muqavileKreditQiymeti').textContent = musteri.kreditQiymeti.toFixed(2);
            document.getElementById('muqavileIlkinOdenis').textContent = musteri.ilkinOdenis.toFixed(2);
            document.getElementById('muqavileKreditMuddeti').textContent = musteri.kreditMuddeti;
            const ayliq = musteri.odenisQrafiki[0].odenmeli;
            document.getElementById('muqavileAyliqOdenis').textContent = ayliq.toFixed(2);
            document.getElementById('muqavileIlkOdenisTarixi').textContent = new Date(musteri.odenisQrafiki[0].tarix).toLocaleDateString('az-AZ');
            
            const qrafikBody = document.getElementById('muqavileQrafikBody');
            qrafikBody.innerHTML = '';
            
            musteri.odenisQrafiki.forEach(ay => {
                 qrafikBody.innerHTML += `
                    <tr>
                        <td>${ay.ay}</td>
                        <td>${new Date(ay.tarix).toLocaleDateString('az-AZ')}</td>
                        <td>${ay.odenmeli.toFixed(2)}</td>
                        <td>Gözləmədə</td>
                    </tr>
                `;
            });
            
            muqavileModal.style.display = 'block';
        }

        function saveAndRender() {
            localStorage.setItem('musteriler', JSON.stringify(musteriler));
            updateDashboard();
            renderMusteriler();
        }

        function getMusteriUmumiQaliqBorc(musteri) {
             const umumiBorc = musteri.odenisQrafiki.reduce((acc, curr) => acc + curr.odenmeli, 0);
             const umumiOdenilmis = musteri.odenisQrafiki.reduce((acc, curr) => acc + curr.odenmis, 0);
             return umumiBorc - umumiOdenilmis;
        }

        function updateDashboard() {
            const aktivMusteriler = musteriler.filter(m => getMusteriUmumiQaliqBorc(m) > 0.01);
            
            document.getElementById('total-customers').textContent = aktivMusteriler.length;
            
            const totalDebt = aktivMusteriler.reduce((acc, m) => acc + getMusteriUmumiQaliqBorc(m), 0);
            document.getElementById('total-debt').textContent = `${Math.max(0, totalDebt).toFixed(2)} AZN`;

            const overdue = aktivMusteriler.filter(m => {
                const novbetiOdenisAyi = m.odenisQrafiki.find(ay => (ay.odenmeli - ay.odenmis) > 0.01);
                return novbetiOdenisAyi && getStatus(novbetiOdenisAyi.tarix).statusCode < 0;
            }).length;
            document.getElementById('overdue-payments').textContent = overdue;

            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const paidThisMonth = musteriler.reduce((acc, m) => {
                const monthPayments = m.odenisQrafiki
                                      .flatMap(ay => ay.odenisler)
                                      .filter(o => {
                                           const oDate = new Date(o.tarix);
                                           return oDate.getMonth() === thisMonth && oDate.getFullYear() === thisYear;
                                      })
                                      .reduce((a, c) => a + c.mebleg, 0);
                return acc + monthPayments;
            }, 0);
            document.getElementById('paid-this-month').textContent = `${paidThisMonth.toFixed(2)} AZN`;
        }
        
        function renderMusteriler() {
            const searchTerm = searchBox.value.toLowerCase();
            let filteredMusteriler = musteriler.filter(m => 
                 (m.adSoyadAta && m.adSoyadAta.toLowerCase().includes(searchTerm)) ||
                 m.finKod.toLowerCase().includes(searchTerm)
            );
            
            filteredMusteriler.forEach(m => {
                const novbetiOdenisAyi = m.odenisQrafiki.find(ay => (ay.odenmeli - ay.odenmis) > 0.01);
                
                m.qaliqBorc = getMusteriUmumiQaliqBorc(m);
                m.qaliqAylar = m.odenisQrafiki.filter(ay => (ay.odenmeli - ay.odenmis) > 0.01).length;

                if (novbetiOdenisAyi) {
                    m.novbetiOdenisTarixi = novbetiOdenisAyi.tarix;
                    m.ayliqOdenis = novbetiOdenisAyi.odenmeli - novbetiOdenisAyi.odenmis;
                    m.status = getStatus(novbetiOdenisAyi.tarix).statusCode;
                } else {
                    m.novbetiOdenisTarixi = '---';
                    m.ayliqOdenis = 0;
                    m.status = 3;
                }
            });

            filteredMusteriler = filteredMusteriler.filter(m => m.qaliqBorc > 0.01);

            if (sortState.column) {
                filteredMusteriler.sort((a, b) => {
                    let valA = a[sortState.column];
                    let valB = b[sortState.column];
                    
                    if (typeof valA === 'string' && sortState.column !== 'novbetiOdenisTarixi') {
                        valA = valA.toLowerCase(); valB = valB.toLowerCase();
                    }

                    if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            tableHeaders.forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                if (icon) {
                    icon.className = 'fas fa-sort sort-icon';
                    if (th.dataset.sort === sortState.column) {
                        th.classList.add('sorted');
                        icon.className = `fas fa-sort-${sortState.direction === 'asc' ? 'up' : 'down'} sort-icon`;
                    }
                }
            });
            
            musteriCedveli.innerHTML = filteredMusteriler.map(musteri => {
                 const { statusClass } = getStatus(musteri.novbetiOdenisTarixi);
                 const novbetiTarix = musteri.novbetiOdenisTarixi !== '---' 
                    ? new Date(musteri.novbetiOdenisTarixi).toLocaleDateString('az-AZ') 
                    : 'Bitib';

                 return `
                    <tr data-id="${musteri.id}">
                        <td><span class="status-indicator ${statusClass}"></span></td>
                        <td>${musteri.adSoyadAta}</td>
                        <td>${Math.max(0, musteri.ayliqOdenis).toFixed(2)} AZN</td>
                        <td>${Math.max(0, musteri.qaliqBorc).toFixed(2)} AZN</td>
                        <td>${musteri.qaliqAylar}</td>
                        <td>${novbetiTarix}</td>
                        <td>
                            <button class="action-btn pay-btn" title="Ödəniş et"><i class="fas fa-dollar-sign"></i></button>
                            <button class="action-btn view-details-btn" title="Bax"><i class="fas fa-eye"></i></button>
                            <button class="action-btn details-btn" title="Ödəniş qrafiki"><i class="fas fa-calendar-alt"></i></button>
                            <button class="action-btn edit-btn" title="Düzəliş et"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" title="Sil"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (filteredMusteriler.length === 0) {
                musteriCedveli.innerHTML = `<tr><td colspan="7" style="text-align:center;">Məlumat tapılmadı.</td></tr>`;
            }
        }
        
        function getStatus(novbetiOdenis) {
            if (novbetiOdenis === '---') return { statusClass: 'status-paid', statusCode: 3, statusText: 'Ödənilib' };
            const buGun = new Date();
            const odenisTarixi = new Date(novbetiOdenis);
            buGun.setHours(0,0,0,0);
            odenisTarixi.setHours(0,0,0,0);

            const ferqGun = Math.ceil((odenisTarixi - buGun) / (1000 * 3600 * 24));
            
            if (ferqGun < 0) return { statusClass: 'status-gecikir', statusCode: -1, statusText: 'Gecikir' };
            if (ferqGun === 0) return { statusClass: 'status-bugun', statusCode: 0, statusText: 'Bu gün' };
            if (ferqGun <= 5) return { statusClass: 'status-yaxinlasir', statusCode: 1, statusText: 'Yaxınlaşır' };
            return { statusClass: 'status-normal', statusCode: 2, statusText: 'Normal' };
        }
        
        function exportToCSV() {
            const headers = ['ID', 'Ad Soyad Ata', 'FİN', 'Vəsiqə Seriyası', 'Məhsul', 'Kredit Qiyməti', 'İlkin Ödəniş', 'Qalıq Borc', 'Qalıq Ay', 'Növbəti Ödəniş Tarixi'];
            const rows = musteriler.filter(m => getMusteriUmumiQaliqBorc(m) > 0.01).map(m => {
                const qaliqBorc = getMusteriUmumiQaliqBorc(m);
                const qaliqAylar = m.odenisQrafiki.filter(ay => (ay.odenmeli - ay.odenmis) > 0.01).length;
                const novbetiOdenisAyi = m.odenisQrafiki.find(ay => (ay.odenmeli - ay.odenmis) > 0.01);
                const novbetiTarix = novbetiOdenisAyi ? new Date(novbetiOdenisAyi.tarix).toLocaleDateString('az-AZ') : '---';

                return [m.id, `"${m.adSoyadAta}"`, m.finKod, m.vesiqeSeria, `"${m.mehsulAdi}"`, m.kreditQiymeti, m.ilkinOdenis, qaliqBorc.toFixed(2), qaliqAylar, novbetiTarix].join(',');
            });

            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [headers.join(','), ...rows].join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "musteri_bazasi.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        calculateKreditDetails();
        saveAndRender();
    });
    </script>
</body>
</html>
