<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kredit İdarəetmə Sistemi (v2.2 - Təkmilləşdirilmiş)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* CSS KODLARI BURADA BAŞLAYIR */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --danger-color: #d0021b;
            --success-color: #7ed321;
            --info-color: #4abde2;
            --dark-color: #2c3e50;
            --dark-color-lighter: #34495e; 
            --light-color: #ecf0f1;
            --background-color: #f4f7f6;
            --text-color: #333;
            --border-color: #e0e0e0; /* Daha yumşaq border rəngi */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sol Menyu (Sidebar) - YENİLƏNMİŞ DİZAYN */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--dark-color) 0%, #1c2833 100%);
            color: var(--light-color);
            padding: 20px 0;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0,0,0,0.2);
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 0 15px;
        }

        .sidebar-header h3 {
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .sidebar-header h3 i {
             color: var(--primary-color);
        }

        .nav-menu {
            list-style: none;
            flex-grow: 1;
        }

        .nav-item a {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: var(--light-color);
            text-decoration: none;
            transition: background-color 0.3s, padding-left 0.3s, color 0.3s;
            border-left: 4px solid transparent;
            position: relative;
        }
        
        .nav-item.has-submenu > a {
            cursor: pointer;
        }
        
        .nav-item.has-submenu > a::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 20px;
            transition: transform 0.3s ease;
        }
        
        .nav-item.has-submenu:hover > a {
            background-color: var(--dark-color-lighter);
        }
        
        .nav-item.has-submenu.submenu-open > a::after {
            transform: rotate(180deg);
        }
        
        .nav-item.active > a, .nav-item > a:hover {
            background-color: var(--primary-color);
            color: #fff;
        }
        
        .nav-item.active > a {
            border-left-color: var(--secondary-color);
            font-weight: 500;
        }

        .nav-item i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
            font-size: 1.1em;
        }
        
        /* Submenu Styles */
        .submenu {
            list-style: none;
            padding-left: 0;
            background-color: #1c2833;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        
        .nav-item.has-submenu.submenu-open > .submenu {
            max-height: 300px;
        }
        
        .submenu a {
            padding-left: 55px;
            font-size: 15px;
            background-color: transparent !important;
        }
        
        .submenu .nav-item a:hover {
             background-color: var(--dark-color-lighter) !important;
             border-left-color: transparent;
        }

        .submenu .nav-item.active a {
             color: var(--secondary-color);
             font-weight: 500;
        }


        /* Əsas Məzmun */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .main-header h1 {
            margin-bottom: 0;
        }
        
        .main-header h2 {
             margin-bottom: 0;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeInScale 0.6s ease-out; /* TƏKMİLLƏŞDİRİLMİŞ ANİMASİYA */
        }
        
        /* TƏKMİLLƏŞDİRİLMİŞ ANİMASİYA */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        h1, h2 {
            color: var(--dark-color);
            margin-bottom: 20px;
        }

        h1 i, h2 i {
            color: var(--primary-color);
        }

        /* Dashboard üçün açılıb-bağlanan panel */
        .collapsible-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            overflow: hidden;
        }
        .collapsible-header {
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
         .collapsible-header h2 {
            margin: 0;
            font-size: 1.2em;
        }
        .collapsible-content {
            padding: 25px;
            max-height: 500px;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        }
        .collapsible-container.collapsed .collapsible-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        .collapsible-header .toggle-icon {
            transition: transform 0.3s ease;
        }
        .collapsible-container.collapsed .toggle-icon {
            transform: rotate(-90deg); /* Oxun istiqaməti dəyişdirildi */
        }
        
        /* Dashboard Kartları - TƏKMİLLƏŞDİRİLMİŞ */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* HOVER ANİMASİYASI */
        }
        /* HOVER ANİMASİYASI */
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
        }
        
        .card .icon {
            font-size: 2.5rem;
            margin-right: 20px;
            padding: 15px;
            border-radius: 50%;
            color: #fff;
        }
        .card.card-customers .icon { background-color: var(--primary-color); }
        .card.card-debt .icon { background-color: var(--danger-color); }
        .card.card-overdue .icon { background-color: var(--secondary-color); }
        .card.card-paid .icon { background-color: var(--success-color); }

        .card .info h3 { font-size: 2rem; color: var(--dark-color); }
        .card .info p { font-size: 0.9rem; color: #777; }

        /* Formalar */
        form {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .form-section-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .input-group select {
            flex: 0 0 80px;
        }
        .input-group input {
            flex: 1;
        }


        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group .checkbox-label {
            flex-direction: row;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }


        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fff;
        }
        
        .form-group input[type="checkbox"] {
            width: auto;
        }

        
        .form-group input:read-only {
            background-color: #f1f1f1;
            cursor: not-allowed;
            font-weight: bold;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
        }
        
        /* Şifrə səhifəsi üçün əlavə stil */
        #sifreler-form .form-group, #sifreler-form-edit .form-group, #magazaAdiFormu .form-group {
            max-width: 400px;
        }
        .password-feedback {
            font-size: 14px;
            margin-top: 5px;
        }
        .password-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }


        .submit-btn {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .submit-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        .submit-btn:hover:not(:disabled) {
            background-color: #3a7ac8;
            transform: translateY(-2px);
        }
        
        .export-btn {
            background-color: var(--success-color);
        }
        .export-btn:hover {
            background-color: #69b31c;
        }

        /* Cədvəl */
        #searchBox {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
        }
        .table-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        
        td .customer-code {
            display: block;
            font-size: 12px;
            color: #777;
        }
        
        tbody tr {
            transition: background-color 0.3s ease; /* HOVER ANİMASİYASI */
        }
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .search-results-table td:last-child {
            width: 1%;
        }
        
        .search-results-table .select-customer-btn {
            padding: 5px 10px;
            font-size: 12px;
            background-color: var(--success-color);
        }


        #tarixceCedveli th, #tarixceCedveli td, #fakturaTarixcesiCedveli th, #fakturaTarixcesiCedveli td {
            padding: 8px 10px;
            font-size: 13px;
            text-align: center;
            vertical-align: middle;
        }
        #tarixceCedveli ul {
            margin: 0; padding: 0 0 0 10px; list-style-type: none; text-align: left;
        }
        #tarixceCedveli ul li {
            font-size: 12px; margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 4px;
        }
        #tarixceCedveli ul li:last-child { border-bottom: none; margin-bottom: 0; }
        #tarixceCedveli .action-btn { padding: 2px 5px; font-size: 11px; }

        thead {
            background-color: #f8f9fa;
        }

        th {
            font-weight: 600;
            color: var(--dark-color);
            cursor: pointer;
            user-select: none;
        }
        th .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
        }
        th.sorted .sort-icon {
            opacity: 1;
        }


        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-gecikir { background-color: var(--danger-color); }
        .status-bugun { background-color: var(--secondary-color); }
        .status-yaxinlasir { background-color: var(--success-color); }
        .status-normal { background-color: #ccc; }
        .status-nagd { background-color: var(--info-color); }
        .status-kredit { background-color: #6c757d; }


        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: #fff;
            margin: 2px;
            font-size: 13px;
            transition: opacity 0.3s;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .pay-btn { background-color: var(--primary-color); }
        .edit-btn { background-color: var(--secondary-color); }
        .delete-btn { background-color: var(--danger-color); }
        .details-btn { background-color: var(--info-color); }
        .view-details-btn { background-color: #6c757d; }
        .print-receipt-btn { background-color: var(--success-color); }


        /* Modal Pəncərələr - TƏKMİLLƏШDİRİLMİŞ */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.4s ease; /* TƏKMİLLƏŞDİRİLMİŞ ANİMASİYA */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }


        #cekModal, #nagdCekModal { z-index: 1050; }
        #confirmModal { z-index: 1060; }
        #passwordChangeModal { z-index: 1070; }


        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            position: relative;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            animation: slideInDown 0.5s ease-out; /* TƏKMİLLƏŞDİRİLMİŞ ANİMASİYA */
        }
        
        .modal-content.modal-sm { max-width: 500px; }
        .modal-content.modal-lg { max-width: 800px; }
        .modal-content.modal-confirm { max-width: 400px; text-align: center; }

        /* TƏKMİLLƏŞDİRİLMİŞ ANİMASİYA */
        @keyframes slideInDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }


        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s, transform 0.3s;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            transform: rotate(90deg);
        }
        
        /* Details Modal Styles */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 25px;
        }
        .details-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .details-item strong {
            color: #555;
            display: block;
            font-size: 13px;
            margin-bottom: 2px;
        }
        .details-item span {
            font-size: 16px;
            color: #333;
        }
        
        .selected-customer-info {
            background-color: #e9f3fe;
            border: 1px solid var(--primary-color);
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        .selected-customer-info p {
            margin: 0;
        }
         .selected-customer-info button {
            margin-left: 15px;
            padding: 2px 8px;
            font-size: 12px;
            background-color: var(--danger-color);
        }


        /* Çek və Müqavilə stilləri */
        .printable-content {
            border: 1px dashed #333;
            padding: 20px;
            margin-bottom: 20px;
        }
        .printable-content h2 { text-align: center; margin-bottom: 15px; }
        .printable-content p { margin-bottom: 10px; font-size: 16px; }
        .printable-content hr { margin: 15px 0; }
        
        #muqavileBody h3 {
            margin-top: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        #muqavileBody .muqavile-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        #muqavileBody .muqavile-row strong {
            color: #555;
        }
        #qrafikCedveli {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        #qrafikCedveli th, #qrafikCedveli td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        #qrafikCedveli thead {
             background-color: #f2f2f2;
        }

        .modal-actions {
            text-align: right;
            margin-top: 20px;
        }
        .modal-actions .submit-btn { margin-left: 10px; }

        #confirmModal .modal-content {
            padding-top: 40px;
        }
        #confirmModal .confirm-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -70px auto 20px;
            box-shadow: 0 4px 10px rgba(245, 166, 35, 0.4);
        }
        #confirmModal h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }
        #confirmModal p {
            margin-bottom: 25px;
            font-size: 16px;
            color: #666;
        }
        #confirmModal .modal-actions {
            justify-content: center;
            display: flex;
            gap: 15px;
        }
        #confirmModal .confirm-btn-yes {
            background-color: var(--success-color);
        }
        #confirmModal .confirm-btn-no {
            background-color: var(--danger-color);
        }

        .paid-row {
            background-color: #e8f5e9;
        }
        .partially-paid-row {
            background-color: #fffde7;
        }


        @media print {
            body * { visibility: hidden; }
            .printable-modal, .printable-modal *, .printable-content, .printable-content * { 
                visibility: visible; 
            }
            .printable-modal { 
                position: absolute; left: 0; top: 0; width: 100%; height: 100%; 
                margin: 0; padding: 0; background: none; overflow: visible !important;
            }
            .modal-content { 
                box-shadow: none; border: none; margin: 0; max-width: 100%; padding: 5px;
            }
            .modal-actions, .close-btn { display: none; }
            
            #muqavileBody, #muqavileBody p { font-size: 10pt; line-height: 1.4; }
            #muqavileBody h2 { font-size: 14pt; }
            #muqavileBody h3 { font-size: 11pt; margin-top: 10px; }
            #qrafikCedveli th, #qrafikCedveli td { padding: 4px; font-size: 9pt; }
        }
        /* CSS KODLARI BURADA BİTİR */
    </style>
</head>
<body>

    <div class="container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-cash-register"></i> Kredit Sistemi</h3>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-target="idarə-paneli-sehifesi"><a href="#"><i class="fas fa-home"></i> Əsas Səhifə</a></li>
                
                <li class="nav-item has-submenu">
                    <a><i class="fas fa-shopping-cart"></i> Satış</a>
                    <ul class="submenu">
                        <li class="nav-item" data-target="yeni-kredit-sehifesi"><a><i class="fas fa-plus-circle"></i> Yeni Kredit</a></li>
                        <li class="nav-item" data-target="nagd-satis-sehifesi"><a><i class="fas fa-dollar-sign"></i> Nağd Satış</a></li>
                    </ul>
                </li>
                
                <li class="nav-item has-submenu">
                    <a><i class="fas fa-money-check-alt"></i> Ödəniş</a>
                    <ul class="submenu">
                        <li class="nav-item" data-target="kassa-medaxil-sehifesi"><a><i class="fas fa-cash-register"></i> Kassa mədaxil</a></li>
                        <li class="nav-item" data-target="kassa-gun-sonu-sehifesi"><a><i class="fas fa-chart-line"></i> Kassa Gün sonu</a></li>
                    </ul>
                </li>

                <li class="nav-item has-submenu">
                    <a><i class="fas fa-users"></i> Müştəri</a>
                    <ul class="submenu">
                        <li class="nav-item" data-target="musteri-bazasi-sehifesi"><a><i class="fas fa-database"></i> Müştəri Bazası</a></li>
                    </ul>
                </li>

                <li class="nav-item has-submenu">
                    <a><i class="fas fa-chart-bar"></i> Hesabat</a>
                    <ul class="submenu">
                        <li class="nav-item" data-target="satis-hesabati-sehifesi"><a><i class="fas fa-file-invoice-dollar"></i> Satış Hesabatı</a></li>
                        <li class="nav-item" data-target="kassa-hesabati-sehifesi"><a><i class="fas fa-cash-register"></i> Kassa Hesabatı</a></li>
                        <li class="nav-item" data-target="bank-odenisleri-sehifesi"><a><i class="fas fa-university"></i> Bank Ödənişləri</a></li>
                    </ul>
                </li>
                 <li class="nav-item has-submenu">
                    <a><i class="fas fa-cogs"></i> Tənzimləmələr</a>
                    <ul class="submenu">
                        <li class="nav-item" data-target="sifreler-sehifesi"><a><i class="fas fa-key"></i> Şifrələr</a></li>
                        <li class="nav-item" data-target="magaza-adi-sehifesi"><a><i class="fas fa-store"></i> Mağaza Adı</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <section id="idarə-paneli-sehifesi" class="page active">
                <div class="main-header"><h1><i class="fas fa-home"></i> Əsas Səhifə</h1></div>
                
                 <div id="dashboard-collapsible" class="collapsible-container">
                    <div class="collapsible-header">
                        <h2><i class="fas fa-database"></i> Ümumi baza məlumatı</h2>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="dashboard-cards">
                            <div class="card card-customers"><div class="icon"><i class="fas fa-users"></i></div><div class="info"><h3 id="total-customers">0</h3><p>Aktiv Müştəri</p></div></div>
                            <div class="card card-debt"><div class="icon"><i class="fas fa-wallet"></i></div><div class="info"><h3 id="total-debt">0 AZN</h3><p>Ümumi Qalıq Borc</p></div></div>
                            <div class="card card-overdue"><div class="icon"><i class="fas fa-exclamation-triangle"></i></div><div class="info"><h3 id="overdue-payments">0</h3><p>Gecikmədə olan</p></div></div>
                            <div class="card card-paid"><div class="icon"><i class="fas fa-check-circle"></i></div><div class="info"><h3 id="paid-this-month">0 AZN</h3><p>Bu Ay Ödənilib</p></div></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="yeni-kredit-sehifesi" class="page">
                <div class="main-header"><h1><i class="fas fa-file-invoice-dollar"></i> Yeni Kredit Müraciəti</h1></div>
                <form id="kreditFormu">
                    <input type="hidden" id="kreditMusteriId">
                    <h3 class="form-section-title">Müştəri Seçimi</h3>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="yeniKreditMusteriCheckbox" checked>
                            <span>Yeni müştəridir?</span>
                        </label>
                    </div>

                    <div id="movcudKreditMusteriFormu" style="display: none;">
                         <div id="selectedKreditCustomerInfo" class="selected-customer-info" style="display:none;"></div>
                         <div id="kreditCustomerSearchArea">
                            <div class="form-row" style="align-items: flex-end;">
                                <div class="form-group" style="flex-grow: 1;">
                                    <label for="kreditMusteriAxtarInput"><i class="fas fa-search"></i> Müştərini axtar (Ad, Kod, FİN, Telefon)</label>
                                    <input type="text" id="kreditMusteriAxtarInput" placeholder="Axtarış üçün məlumat daxil edin...">
                                </div>
                                <div class="form-group">
                                    <button type="button" id="kreditMusteriAxtarBtn" class="submit-btn" style="margin-top: 0;"><i class="fas fa-search"></i> Axtar</button>
                                </div>
                            </div>
                             <div id="kreditMusteriAxtarNeticeleri" class="table-container" style="display: none;">
                                <table class="search-results-table">
                                    <thead><tr><th>Müştəri</th><th>FİN Kod</th><th>Telefonlar</th><th>Seç</th></tr></thead>
                                    <tbody id="kreditMusteriAxtarCedveli"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="yeniKreditMusteriFormu">
                        <h3 class="form-section-title">Müştəri Məlumatları</h3>
                        <div class="form-row">
                            <div class="form-group"><label for="ad"><i class="fas fa-user"></i> Ad</label><input type="text" id="ad" required></div>
                            <div class="form-group"><label for="soyad"><i class="fas fa-user"></i> Soyad</label><input type="text" id="soyad" required></div>
                            <div class="form-group"><label for="ataAdi"><i class="fas fa-user"></i> Ata adı</label><input type="text" id="ataAdi" required></div>
                        </div>
                        <div class="form-row">
                             <div class="form-group"><label for="cins"><i class="fas fa-venus-mars"></i> Cins</label>
                                <select id="cins" required>
                                    <option value="Kişi">Kişi</option>
                                    <option value="Qadın">Qadın</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="finKod"><i class="fas fa-id-card"></i> FİN Kod</label><input type="text" id="finKod" required minlength="7" maxlength="7"></div>
                            <div class="form-group">
                                <label for="vesiqeSeria">Vəsiqə Seriya və Nömrəsi</label>
                                <div class="input-group">
                                    <select id="vesiqeSeria"><option value="AZE">AZE</option><option value="AA">AA</option></select>
                                    <input type="text" id="vesiqeNomre" class="numeric-input" required pattern="\d{7}" maxlength="7" placeholder="1234567">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mobil1-nomre"><i class="fas fa-mobile-alt"></i> Əsas Mobil Nömrə</label>
                                <div class="input-group">
                                    <select id="mobil1-prefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select>
                                    <input type="tel" id="mobil1-nomre" class="numeric-input" required pattern="\d{7}" maxlength="7" placeholder="1234567">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mobil2-nomre"><i class="fas fa-phone"></i> Əlavə Nömrə 1</label>
                                 <div class="input-group">
                                    <select id="mobil2-prefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select>
                                    <input type="tel" id="mobil2-nomre" class="numeric-input" pattern="\d{7}" maxlength="7" placeholder="1234567">
                                </div>
                            </div>
                             <div class="form-group">
                                <label for="mobil3-nomre"><i class="fas fa-phone"></i> Əlavə Nömrə 2</label>
                                 <div class="input-group">
                                    <select id="mobil3-prefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select>
                                    <input type="tel" id="mobil3-nomre" class="numeric-input" pattern="\d{7}" maxlength="7" placeholder="1234567">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="form-section-title">Kredit Məlumatları</h3>
                     <div class="form-row">
                        <div class="form-group"><label for="mehsulAdi"><i class="fas fa-box"></i> Məhsulun Adı</label><input type="text" id="mehsulAdi" required></div>
                        <div class="form-group">
                            <label for="mehsulKateqoriya"><i class="fas fa-tags"></i> Kateqoriya</label>
                            <select id="mehsulKateqoriya" required>
                                <option value="" disabled selected>Kateqoriya seçin</option>
                                <option value="Mobil telefon">Mobil telefon</option>
                                <option value="Böyük məişət texnikası">Böyük məişət texnikası</option>
                                <option value="Kiçik məişət texnikası">Kiçik məişət texnikası</option>
                                <option value="Aksesuar">Aksesuar</option>
                                <option value="Digər">Digər</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="nagdQiymet"><i class="fas fa-money-bill-wave"></i> Nağd Qiyməti (AZN)</label><input type="number" id="nagdQiymet" required min="0"></div>
                         <div class="form-group"><label for="kreditMuddeti"><i class="fas fa-calendar-alt"></i> Kredit Müddəti (Ay)</label>
                             <select id="kreditMuddeti">
                                <option value="3">3 Ay (+8%)</option>
                                <option value="6">6 Ay (+8%)</option>
                                <option value="9">9 Ay (+8%)</option>
                                <option value="12" selected>12 Ay (+15%)</option>
                                <option value="18">18 Ay (+20%)</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="ilkinOdenis"><i class="fas fa-hand-holding-usd"></i> İlkin Ödəniş (AZN)</label><input type="number" id="ilkinOdenis" value="0" min="0"></div>
                    </div>
                     <div class="form-row" style="background: #f8f9fa; padding: 15px; border-radius: 5px; align-items: center;">
                        <div class="form-group"><label for="kreditQiymeti"><i class="fas fa-credit-card"></i> Ümumi Kredit Məbləği (AZN)</label><input type="text" id="kreditQiymeti" readonly></div>
                        <div class="form-group"><label for="ayliqOdenis"><i class="fas fa-calendar-check"></i> Aylıq Ödəniş (AZN)</label><input type="text" id="ayliqOdenis" readonly></div>
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-file-signature"></i> Müqaviləyə Bax</button>
                </form>
            </section>
            
            <section id="nagd-satis-sehifesi" class="page">
                <div class="main-header"><h1><i class="fas fa-dollar-sign"></i> Nağd Satış</h1></div>
                <form id="nagdFormu">
                    <input type="hidden" id="nagdMusteriId">
                    <h3 class="form-section-title">Məhsul Məlumatları</h3>
                    <div class="form-row">
                        <div class="form-group"><label for="nagdMehsulAdi"><i class="fas fa-box"></i> Məhsulun Adı</label><input type="text" id="nagdMehsulAdi" required></div>
                        <div class="form-group"><label for="nagdMehsulQiymeti"><i class="fas fa-money-bill-wave"></i> Satış Qiyməti (AZN)</label><input type="number" id="nagdMehsulQiymeti" required min="0"></div>
                    </div>
                    
                    <h3 class="form-section-title">Müştəri Məlumatları</h3>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="yeniMusteriCheckbox">
                            <span>Yeni müştəri kimi qeyd et</span>
                        </label>
                    </div>

                    <div id="yeniMusteriFormu" style="display: none;">
                        <div class="form-row">
                            <div class="form-group"><label for="nagdAd"><i class="fas fa-user"></i> Ad</label><input type="text" id="nagdAd"></div>
                             <div class="form-group"><label for="nagdSoyad"><i class="fas fa-user"></i> Soyad</label><input type="text" id="nagdSoyad"></div>
                             <div class="form-group"><label for="nagdAtaAdi"><i class="fas fa-user"></i> Ata adı</label><input type="text" id="nagdAtaAdi"></div>
                        </div>
                        <div class="form-row">
                             <div class="form-group"><label for="nagdCins"><i class="fas fa-venus-mars"></i> Cins</label>
                                <select id="nagdCins">
                                    <option value="Kişi">Kişi</option>
                                    <option value="Qadın">Qadın</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="nagdFinKod"><i class="fas fa-id-card"></i> FİN Kod</label><input type="text" id="nagdFinKod" minlength="7" maxlength="7"></div>
                            <div class="form-group">
                                <label for="nagdMobilNomre"><i class="fas fa-mobile-alt"></i> Mobil Nömrə</label>
                                <div class="input-group">
                                    <select id="nagdMobilPrefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select>
                                    <input type="tel" id="nagdMobilNomre" class="numeric-input" pattern="\d{7}" maxlength="7">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="movcudMusteriFormu">
                         <div id="selectedCustomerInfo" class="selected-customer-info" style="display:none;"></div>
                         <div id="customerSearchArea">
                            <div class="form-row" style="align-items: flex-end;">
                                <div class="form-group" style="flex-grow: 1;">
                                    <label for="nagdMusteriAxtarInput"><i class="fas fa-search"></i> Müştərini axtar (Ad, Kod, FİN, Telefon)</label>
                                    <input type="text" id="nagdMusteriAxtarInput" placeholder="Axtarış üçün məlumat daxil edin...">
                                </div>
                                <div class="form-group">
                                     <button type="button" id="nagdMusteriAxtarBtn" class="submit-btn" style="margin-top: 0;"><i class="fas fa-search"></i> Axtar</button>
                                </div>
                            </div>
                             <div id="nagdMusteriAxtarNeticeleri" class="table-container" style="display: none;">
                                <table class="search-results-table">
                                    <thead><tr><th>Müştəri</th><th>FİN Kod</th><th>Telefonlar</th><th>Seç</th></tr></thead>
                                    <tbody id="nagdMusteriAxtarCedveli"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <h3 class="form-section-title">Ödəniş Məlumatları</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nagdOdenisUsulu"><i class="fas fa-credit-card"></i> Ödəniş Üsulu</label>
                            <select id="nagdOdenisUsulu">
                                <option value="Nağd">Nağd</option>
                                <option value="Kart ilə">Kart ilə</option>
                                <option value="Kart/Nağd">Kart/Nağd</option>
                            </select>
                        </div>
                    </div>
                    <div id="nagdMixedPaymentDiv" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nagdKartMebleg">Kart ilə (AZN)</label>
                                <input type="number" id="nagdKartMebleg" step="0.01" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="nagdNagdMebleg">Nağd (AZN)</label>
                                <input type="number" id="nagdNagdMebleg" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn"><i class="fas fa-check-circle"></i> Satışı Tamamla</button>
                </form>
            </section>
            
            <section id="kassa-medaxil-sehifesi" class="page">
                <div class="main-header">
                    <h1><i class="fas fa-cash-register"></i> Kassa mədaxil</h1>
                </div>
                <form id="kassaAxtarFormu">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="kassaAxtarAd"><i class="fas fa-user"></i> Müştəri (Ad, Kod)</label>
                            <input type="text" id="kassaAxtarAd" placeholder="Ad və ya müştəri kodu daxil edin...">
                        </div>
                        <div class="form-group">
                            <label for="kassaAxtarFin"><i class="fas fa-id-card"></i> FİN Kod</label>
                            <input type="text" id="kassaAxtarFin" placeholder="FİN kodu daxil edin...">
                        </div>
                        <div class="form-group">
                            <label for="kassaAxtarTel"><i class="fas fa-phone"></i> Telefon Nömrəsi</label>
                            <input type="text" id="kassaAxtarTel" placeholder="Nömrəni daxil edin...">
                        </div>
                    </div>
                     <button type="submit" class="submit-btn">
                         <i class="fas fa-search"></i>
                         <span>Axtar</span>
                     </button>
                </form>
                
                <div id="kassaAxtarNeticeleri" class="table-container search-results-table" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Müştəri</th>
                                <th>Məhsul (Faktura)</th>
                                <th>Qalıq Borc</th>
                                <th>Növbəti Ödəniş</th>
                                <th>Əməliyyat</th>
                            </tr>
                        </thead>
                        <tbody id="kassaAxtarCedveli"></tbody>
                    </table>
                </div>
            </section>

            <section id="kassa-gun-sonu-sehifesi" class="page">
                <div class="main-header">
                    <h1><i class="fas fa-chart-line"></i> Kassa Gün Sonu Hesabatı</h1>
                </div>
            
                <div class="dashboard-cards" style="margin-bottom: 25px;">
                    <div class="card card-paid">
                        <div class="icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="info">
                            <h3 id="gunSonuNagdCemi">0.00 AZN</h3>
                            <p>Nağd Mədaxil</p>
                        </div>
                    </div>
                    <div class="card card-customers">
                        <div class="icon"><i class="far fa-credit-card"></i></div>
                        <div class="info">
                            <h3 id="gunSonuKartCemi">0.00 AZN</h3>
                            <p>Kart Mədaxil</p>
                        </div>
                    </div>
                     <div class="card card-debt">
                        <div class="icon"><i class="fas fa-wallet"></i></div>
                        <div class="info">
                            <h3 id="gunSonuUmumiCemi">0.00 AZN</h3>
                            <p>Ümumi Mədaxil</p>
                        </div>
                    </div>
                </div>
            
            </section>

            <section id="musteri-bazasi-sehifesi" class="page">
                <div class="main-header">
                    <h1><i class="fas fa-database"></i> Müştəri Bazası</h1>
                </div>
                <input type="text" id="searchBox" placeholder="Ada, soyada, koda və ya FİN-ə görə axtar...">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-sort="status">Status</th>
                                <th data-sort="ad">Müştəri <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="ayliqOdenis">Növbəti Ödəniş <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="qaliqBorc">Ümumi Qalıq Borc <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="novbetiOdenisTarixi">Ən Yaxın Ödəniş Tarixi <i class="fas fa-sort sort-icon"></i></th>
                                <th>Əməliyyatlar</th>
                            </tr>
                        </thead>
                        <tbody id="musteriCedveli"></tbody>
                    </table>
                </div>
            </section>
            
            <section id="satis-hesabati-sehifesi" class="page">
                <div class="main-header">
                    <h1><i class="fas fa-file-invoice-dollar"></i> Satış Hesabatı</h1>
                </div>
                <form id="satisHesabatiFormu">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="satisHesabatiBaslamaTarixi">Başlama Tarixi</label>
                            <input type="date" id="satisHesabatiBaslamaTarixi" required>
                        </div>
                        <div class="form-group">
                            <label for="satisHesabatiBitmeTarixi">Bitmə Tarixi</label>
                            <input type="date" id="satisHesabatiBitmeTarixi" required>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-filter"></i> Filterlə</button>
                </form>
                <div class="table-container" style="margin-top: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Faktura ID</th>
                                <th>Tarix</th>
                                <th>Müştəri Adı</th>
                                <th>Məbləğ (AZN)</th>
                                <th>Ödəniş Üsulu</th>
                            </tr>
                        </thead>
                        <tbody id="satisHesabatiCedveli">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="kassa-hesabati-sehifesi" class="page">
                <div class="main-header">
                    <h1><i class="fas fa-cash-register"></i> Kassa Hesabatı</h1>
                </div>
                <form id="kassaHesabatiFormu">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="kassaHesabatiBaslamaTarixi">Başlama Tarixi</label>
                            <input type="date" id="kassaHesabatiBaslamaTarixi" required>
                        </div>
                        <div class="form-group">
                            <label for="kassaHesabatiBitmeTarixi">Bitmə Tarixi</label>
                            <input type="date" id="kassaHesabatiBitmeTarixi" required>
                        </div>
                        <div class="form-group">
                            <label for="kassaHesabatiOdenisUsulu">Ödəniş Üsulu</label>
                            <select id="kassaHesabatiOdenisUsulu">
                                <option value="Hamisi">Hamısı</option>
                                <option value="Nağd">Nağd</option>
                                <option value="Kart">Kart</option>
                                <option value="Kart/Nağd">Kart/Nağd</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-filter"></i> Filterlə</button>
                </form>
                <div class="table-container" style="margin-top: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Ödəniş ID</th>
                                <th>Tarix</th>
                                <th>Müştəri Adı</th>
                                <th>Məhsul (Faktura)</th>
                                <th>Məbləğ (AZN)</th>
                                <th>Ödəniş Üsulu</th>
                            </tr>
                        </thead>
                        <tbody id="kassaHesabatiCedveli">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="bank-odenisleri-sehifesi" class="page">
                <div class="main-header">
                    <h1><i class="fas fa-university"></i> Bank Ödənişləri</h1>
                </div>
                <form id="bankOdenisleriFormu">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bankOdenisleriTarix">Tarix seçin</label>
                            <input type="date" id="bankOdenisleriTarix" required>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-eye"></i> Göstər</button>
                </form>
                <div class="dashboard-cards" style="margin-top: 25px;">
                     <div class="card card-customers">
                        <div class="icon"><i class="far fa-credit-card"></i></div>
                        <div class="info">
                            <h3 id="bankOdenisleriCemi">0.00 AZN</h3>
                            <p>Seçilmiş Gün üzrə Kart Mədaxili</p>
                        </div>
                    </div>
                </div>
            </section>
            <section id="sifreler-sehifesi" class="page">
                <div class="main-header">
                    <h1><i class="fas fa-key"></i> Şifrələrin İdarə Olunması</h1>
                </div>
                
                 <div class="password-buttons-container">
                    <button id="showDeletePassFormBtn" class="submit-btn"><i class="fas fa-trash-alt"></i> Silmə Şifrəsini Dəyiş</button>
                    <button id="showEditPassFormBtn" class="submit-btn" style="background-color: var(--secondary-color);"><i class="fas fa-edit"></i> Düzəliş Şifrəsini Dəyiş</button>
                </div>

            </section>
             <section id="magaza-adi-sehifesi" class="page">
                <div class="main-header">
                    <h1><i class="fas fa-store"></i> Mağaza Adının Tənzimlənməsi</h1>
                </div>
                <form id="magazaAdiFormu">
                    <h3 class="form-section-title">Mağaza Məlumatları</h3>
                    <div class="form-group">
                        <label for="magazaAdiInput"><i class="fas fa-signature"></i> Mağaza Adı</label>
                        <input type="text" id="magazaAdiInput" placeholder="Məsələn: Texno Ev" required>
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-save"></i> Yadda Saxla</button>
                </form>
            </section>
        </main>
    </div>

    <div id="passwordChangeModal" class="modal">
        <div class="modal-content modal-sm">
            <span class="close-btn" id="closePasswordChangeModal">&times;</span>
            <h2 id="passwordModalTitle" style="margin-bottom: 20px;">Şifrəni dəyiş</h2>
            
            <div id="deletePassFormContainer" style="display: none;">
                <form id="sifreler-form" style="box-shadow: none; padding: 0;">
                    <div class="form-group">
                        <label for="delete-current-pass">Cari Şifrə</label>
                        <input type="password" id="delete-current-pass" required>
                    </div>
                    <div class="form-group">
                        <label for="delete-new-pass">Yeni Şifrə</label>
                        <input type="password" id="delete-new-pass" required>
                    </div>
                    <button type="submit" data-pass-type="delete" class="submit-btn"><i class="fas fa-save"></i> Dəyişdir</button>
                    <p class="password-feedback" id="delete-feedback"></p>
                </form>
            </div>

            <div id="editPassFormContainer" style="display: none;">
                <form id="sifreler-form-edit" style="box-shadow: none; padding: 0;">
                    <div class="form-group">
                        <label for="edit-current-pass">Cari Şifrə</label>
                        <input type="password" id="edit-current-pass" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-new-pass">Yeni Şifrə</label>
                        <input type="password" id="edit-new-pass" required>
                    </div>
                    <button type="submit" data-pass-type="edit" class="submit-btn"><i class="fas fa-save"></i> Dəyişdir</button>
                    <p class="password-feedback" id="edit-feedback"></p>
                </form>
            </div>
        </div>
    </div>
    
    <div id="detailsModal" class="modal">
        <div class="modal-content modal-lg"> <span class="close-btn" id="closeDetailsModal">&times;</span>
            <div class="main-header" style="margin-bottom: 15px;">
                 <h2 style="margin-bottom: 0;"><i class="fas fa-user-tag"></i> Müştəri Məlumatları</h2>
            </div>
            <h3 class="form-section-title">Şəxsi Məlumatlar</h3>
            <div class="details-grid">
                <div class="details-item"><strong>Müştəri Kodu</strong><span id="detailsMusteriKodu"></span></div>
                <div class="details-item"><strong>Ad, Soyad, Ata adı</strong><span id="detailsAdSoyad"></span></div>
                <div class="details-item"><strong>Cins</strong><span id="detailsCins"></span></div>
                <div class="details-item"><strong>FİN Kod</strong><span id="detailsFinKod"></span></div>
                <div class="details-item"><strong>Vəsiqə Seriya və Nömrəsi</strong><span id="detailsVesiqe"></span></div>
                <div class="details-item"><strong>Mobil Nömrələr</strong><span id="detailsNomreler"></span></div>
            </div>
            
            <h3 class="form-section-title">Faktura Tarixçəsi</h3>
            <div class="table-container">
                <table id="fakturaTarixcesiCedveli">
                    <thead>
                        <tr>
                            <th>Faktura ID</th>
                            <th>Tarix</th>
                            <th>Növ</th>
                            <th>Məhsul/Təsvir</th>
                            <th>Məbləğ / Qalıq Borc</th>
                            <th>Əməliyyat</th>
                        </tr>
                    </thead>
                    <tbody id="fakturaTarixcesiBody"></tbody>
                </table>
            </div>

        </div>
    </div>

    <div id="odenisModal" class="modal"><div class="modal-content modal-sm"><span class="close-btn" id="closeOdenisModal">&times;</span><h2><i class="fas fa-wallet"></i> Ödəniş Et</h2><form id="odenisFormu"><p><strong>Müştəri:</strong> <span id="modalMusteriAdi"></span></p><p><strong>Məhsul:</strong> <span id="modalMehsulAdi"></span></p><p><strong>Bu Ay Ödənilməlidir:</strong> <span id="modalAyliqOdenis"></span> AZN</p><input type="hidden" id="modalMusteriId"><input type="hidden" id="modalFakturaId"><input type="hidden" id="modalOdenisAyIndex"><div class="form-group"><label for="odenilenMebleg">Ödənilən Məbləğ (AZN)</label><input type="number" id="odenilenMebleg" step="0.01" required></div><div class="form-group"><label for="odenisUsulu">Ödəniş Üsulu</label><select id="odenisUsulu"><option value="Nağd">Nağd</option><option value="Kart">Kart ilə</option><option value="Kart/Nağd">Kart/Nağd</option></select></div><div id="mixedPaymentDiv" style="display: none;"><div class="form-row"><div class="form-group"><label for="odenisKartMebleg">Kart ilə (AZN)</label><input type="number" id="odenisKartMebleg" step="0.01" min="0" value="0"></div><div class="form-group"><label for="odenisNagdMebleg">Nağd (AZN)</label><input type="number" id="odenisNagdMebleg" step="0.01" min="0" value="0"></div></div></div><button type="submit" class="submit-btn"><i class="fas fa-dollar-sign"></i> Ödənişi Təsdiqlə</button></form></div></div>
    
    <div id="cekModal" class="modal printable-modal"><div class="modal-content modal-sm" id="cekContent"><span class="close-btn" id="closeCekModal">&times;</span><div id="cekBody" class="printable-content"><h2>KREDİT ÖDƏNİŞ QƏBZİ</h2><p><strong>Satıcı:</strong> <span id="cekSatici"></span></p><p><strong>Qəbz ID:</strong> <span id="cekId"></span></p><p><strong>Tarix:</strong> <span id="cekTarix"></span></p><hr><p><strong>Müştəri:</strong> <span id="cekMusteriAdi"></span></p><p><strong>Faktura üzrə Məhsul:</strong> <span id="cekMehsulAdi"></span></p><p><strong>Ödənilən Məbləğ:</strong> <span id="cekOdenenMebleg"></span> AZN</p><p><strong>Ödəniş Üsulu:</strong> <span id="cekOdenisUsulu"></span></p><hr><p><strong>Faktura üzrə Qalıq Borc:</strong> <span id="cekFakturaQaliqBorc"></span> AZN</p><p><strong>Ümumi Qalıq Borc:</strong> <span id="cekUmumiQaliqBorc"></span> AZN</p></div><div class="modal-actions"><button id="printCekBtn" class="submit-btn"><i class="fas fa-print"></i> Çap Et</button></div></div></div>

    <div id="nagdCekModal" class="modal printable-modal"><div class="modal-content modal-sm"><span class="close-btn" id="closeNagdCekModal">&times;</span><div id="nagdCekBody" class="printable-content"><h2>NAĞD SATIŞ QƏBZİ</h2><p><strong>Satıcı:</strong> <span id="nagdCekSatici"></span></p><p><strong>Qəbz ID:</strong> <span id="nagdCekId"></span></p><p><strong>Tarix:</strong> <span id="nagdCekTarix"></span></p><hr><p><strong>Müştəri:</strong> <span id="nagdCekMusteriAdi"></span></p><hr><p><strong>Məhsul:</strong> <span id="nagdCekMehsulAdi"></span></p><p><strong>Məbləğ:</strong> <span id="nagdCekOdenenMebleg"></span> AZN</p><p><strong>Ödəniş Üsulu:</strong> <span id="nagdCekOdenisUsulu"></span></p></div><div class="modal-actions"><button id="printNagdCekBtn" class="submit-btn"><i class="fas fa-print"></i> Çap Et</button></div></div></div>
    
    <div id="editModal" class="modal"><div class="modal-content modal-lg"><span class="close-btn" id="closeEditModal">&times;</span><h2><i class="fas fa-edit"></i> Məlumatlara Düzəliş Et</h2><form id="editMusteriFormu"><input type="hidden" id="editMusteriId"><h3 class="form-section-title">Şəxsi Məlumatlar (Dəyişdirilə bilər)</h3>
    <div class="form-row">
        <div class="form-group"><label for="editAd">Ad</label><input type="text" id="editAd" required></div>
        <div class="form-group"><label for="editSoyad">Soyad</label><input type="text" id="editSoyad" required></div>
        <div class="form-group"><label for="editAtaAdi">Ata adı</label><input type="text" id="editAtaAdi" required></div>
    </div>
    <div class="form-row">
        <div class="form-group"><label for="editCins">Cins</label>
            <select id="editCins" required>
                <option value="Kişi">Kişi</option>
                <option value="Qadın">Qadın</option>
            </select>
        </div>
        <div class="form-group"><label for="editFinKod">FİN Kod</label><input type="text" id="editFinKod" required minlength="7" maxlength="7"></div>
        <div class="form-group"><label for="editVesiqeSeria">Vəsiqə Seriya və Nömrəsi</label><div class="input-group"><select id="editVesiqeSeria"><option value="AZE">AZE</option><option value="AA">AA</option></select><input type="text" id="editVesiqeNomre" class="numeric-input" required pattern="\d{7}" maxlength="7"></div></div>
    </div><div class="form-row"><div class="form-group"><label for="editMobil1">Əsas Mobil Nömrə</label><input type="tel" id="editMobil1" required></div><div class="form-group"><label for="editMobil2">Əlavə Nömrə 1</label><input type="tel" id="editMobil2"></div><div class="form-group"><label for="editMobil3">Əlavə Nömrə 2</label><input type="tel" id="editMobil3"></div></div><p style="font-size: 14px; color: #777;">*Kredit və satış məlumatları (fakturalar) dəyişdirilə bilməz. Onlara düzəliş etmək üçün ödəniş cədvəlindən istifadə edin.</p><button type="submit" class="submit-btn"><i class="fas fa-save"></i> Dəyişiklikləri Yadda Saxla</button></form></div></div>

    <div id="muqavileModal" class="modal printable-modal"><div class="modal-content modal-lg"><span class="close-btn" id="closeMuqavileModal">&times;</span><div id="muqavileBody" class="printable-content"><h2>Alqı-Satqı və Kredit Müqaviləsi</h2><p><strong>Tarix:</strong> <span id="muqavileTarix"></span></p><hr><h3>Tərəflər</h3><p><strong>Satıcı:</strong> <span id="muqavileSatici"></span></p><p><strong>Alıcı:</strong> <span id="muqavileMusteriAdi"></span> (<span id="muqavileMusteriKodu"></span>)</p><div class="muqavile-row"><p><strong>FİN Kod:</strong> <span id="muqavileFinKod"></span></p><p><strong>Vəsiqə:</strong> <span id="muqavileVesiqe"></span></p></div><hr><h3>Müqavilənin Predmeti</h3><div class="muqavile-row"><span><strong>Məhsul:</strong> <span id="muqavileMehsul"></span></span><span><strong>Kateqoriya:</strong> <span id="muqavileKateqoriya"></span></span></div><hr><h3>Kredit Şərtləri</h3><div class="muqavile-row"><span><strong>Nağd Qiymət:</strong> <span id="muqavileNagdQiymet"></span> AZN</span><span><strong>Kreditlə Qiymət:</strong> <span id="muqavileKreditQiymeti"></span> AZN</span></div><div class="muqavile-row"><span><strong>İlkin Ödəniş:</strong> <span id="muqavileIlkinOdenis"></span> AZN</span><span><strong>Kredit Müddəti:</strong> <span id="muqavileKreditMuddeti"></span> ay</span></div><div class="muqavile-row"><span><strong>Aylıq Ödəniş:</strong> <span id="muqavileAyliqOdenis"></span> AZN</span><span><strong>İlk Ödəniş Tarixi:</strong> <span id="muqavileIlkOdenisTarixi"></span></span></div><hr><h3>Ödəniş Cədvəli</h3><table id="qrafikCedveli"><thead><tr><th>Ay</th><th>Ödəniş Tarixi</th><th>Məbləğ (AZN)</th><th>Status</th></tr></thead><tbody id="muqavileQrafikBody"></tbody></table><br><div class="muqavile-row" style="margin-top: 40px;"><p><strong>Satıcı: _______________</strong></p><p><strong>Alıcı: _______________</strong></p></div></div><div class="modal-actions"><button id="printMuqavileBtn" class="submit-btn export-btn"><i class="fas fa-print"></i> Çap Et</button><button id="confirmMuqavileBtn" class="submit-btn"><i class="fas fa-check"></i> Təsdiqlə və Yadda Saxla</button></div></div></div>
    
    <div id="odenisTarixcesiModal" class="modal printable-modal">
        <div class="modal-content modal-lg">
            <span class="close-btn" id="closeTarixceModal">&times;</span>
            <div class="main-header" style="margin-bottom: 15px;">
                <h2 id="tarixceModalTitle" style="margin-bottom: 0;"><i class="fas fa-history"></i> Ödəniş Qrafiki</h2>
            </div>
            <div id="tarixce-printable-area">
                <p><strong>Müştəri:</strong> <span id="tarixceMusteriAdi"></span></p>
                <p><strong>Məhsul (Faktura):</strong> <span id="tarixceMehsulAdi"></span></p>
                <div class="table-container">
                    <table id="tarixceCedveli">
                        <thead><tr id="tarixceCedveliHead"></tr></thead>
                        <tbody id="tarixceCedveliBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-actions">
                 <button id="tarixce-print-btn" class="submit-btn export-btn" style="margin-top: 0; display: none;"><i class="fas fa-print"></i> Çap Et</button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal">
        <div class="modal-content modal-confirm">
            <div class="confirm-icon"><i class="fas fa-question"></i></div>
            <h3 id="confirmTitle">Təsdiq</h3>
            <p id="confirmText">Bu əməliyyatı təsdiqləyirsiniz?</p>
            <div class="modal-actions">
                <button id="confirmBtnYes" class="submit-btn confirm-btn-yes"><i class="fas fa-check"></i> Bəli</button>
                <button id="confirmBtnNo" class="submit-btn confirm-btn-no"><i class="fas fa-times"></i> Xeyr</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // === ELEMENT SEÇİMLƏRİ ===
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        const kreditFormu = document.getElementById('kreditFormu');
        const musteriCedveli = document.getElementById('musteriCedveli');
        const searchBox = document.getElementById('searchBox');
        const tableHeaders = document.querySelectorAll('#musteri-bazasi-sehifesi thead th');

        const nagdQiymetInput = document.getElementById('nagdQiymet');
        const kreditMuddetiSelect = document.getElementById('kreditMuddeti');
        const ilkinOdenisInput = document.getElementById('ilkinOdenis');
        const kreditQiymetiInput = document.getElementById('kreditQiymeti');
        const ayliqOdenisInput = document.getElementById('ayliqOdenis');
        
        const kassaAxtarFormu = document.getElementById('kassaAxtarFormu');
        const kassaAxtarNeticeleri = document.getElementById('kassaAxtarNeticeleri');
        const kassaAxtarCedveli = document.getElementById('kassaAxtarCedveli');
        
        const magazaAdiFormu = document.getElementById('magazaAdiFormu');
        const magazaAdiInput = document.getElementById('magazaAdiInput');

        const satisHesabatiFormu = document.getElementById('satisHesabatiFormu');
        const kassaHesabatiFormu = document.getElementById('kassaHesabatiFormu');
        const bankOdenisleriFormu = document.getElementById('bankOdenisleriFormu');

        const dashboardCollapsible = document.getElementById('dashboard-collapsible');
        
        const passwordChangeModal = document.getElementById('passwordChangeModal');
        const closePasswordChangeModal = document.getElementById('closePasswordChangeModal');
        const passwordModalTitle = document.getElementById('passwordModalTitle');
        const sifrelerForm = document.getElementById('sifreler-form');
        const sifrelerFormEdit = document.getElementById('sifreler-form-edit');
        const showDeletePassFormBtn = document.getElementById('showDeletePassFormBtn');
        const showEditPassFormBtn = document.getElementById('showEditPassFormBtn');
        const deletePassFormContainer = document.getElementById('deletePassFormContainer');
        const editPassFormContainer = document.getElementById('editPassFormContainer');
        
        const nagdFormu = document.getElementById('nagdFormu');
        const yeniMusteriCheckbox = document.getElementById('yeniMusteriCheckbox');
        const yeniMusteriFormu = document.getElementById('yeniMusteriFormu');
        const movcudMusteriFormu = document.getElementById('movcudMusteriFormu');
        const nagdMusteriAxtarInput = document.getElementById('nagdMusteriAxtarInput');
        const nagdMusteriAxtarBtn = document.getElementById('nagdMusteriAxtarBtn');
        const nagdMusteriAxtarCedveli = document.getElementById('nagdMusteriAxtarCedveli');
        const nagdMusteriAxtarNeticeleri = document.getElementById('nagdMusteriAxtarNeticeleri');
        const selectedCustomerInfo = document.getElementById('selectedCustomerInfo');
        const customerSearchArea = document.getElementById('customerSearchArea');

        const yeniKreditMusteriCheckbox = document.getElementById('yeniKreditMusteriCheckbox');
        const yeniKreditMusteriFormu = document.getElementById('yeniKreditMusteriFormu');
        const movcudKreditMusteriFormu = document.getElementById('movcudKreditMusteriFormu');
        const kreditMusteriAxtarInput = document.getElementById('kreditMusteriAxtarInput');
        const kreditMusteriAxtarBtn = document.getElementById('kreditMusteriAxtarBtn');
        const kreditMusteriAxtarCedveli = document.getElementById('kreditMusteriAxtarCedveli');
        const kreditMusteriAxtarNeticeleri = document.getElementById('kreditMusteriAxtarNeticeleri');
        const selectedKreditCustomerInfo = document.getElementById('selectedKreditCustomerInfo');
        const kreditCustomerSearchArea = document.getElementById('kreditCustomerSearchArea');

        const odenisModal = document.getElementById('odenisModal');
        const cekModal = document.getElementById('cekModal');
        const nagdCekModal = document.getElementById('nagdCekModal');
        const editModal = document.getElementById('editModal');
        const muqavileModal = document.getElementById('muqavileModal');
        const odenisTarixcesiModal = document.getElementById('odenisTarixcesiModal');
        const detailsModal = document.getElementById('detailsModal');
        const confirmModal = document.getElementById('confirmModal'); 

        const closeOdenisModal = document.getElementById('closeOdenisModal');
        const closeCekModal = document.getElementById('closeCekModal');
        const closeNagdCekModal = document.getElementById('closeNagdCekModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const closeMuqavileModal = document.getElementById('closeMuqavileModal');
        const closeTarixceModal = document.getElementById('closeTarixceModal');
        const closeDetailsModal = document.getElementById('closeDetailsModal');

        const odenisFormu = document.getElementById('odenisFormu');
        const editMusteriFormu = document.getElementById('editMusteriFormu');
        const printCekBtn = document.getElementById('printCekBtn');
        const printNagdCekBtn = document.getElementById('printNagdCekBtn');
        const printMuqavileBtn = document.getElementById('printMuqavileBtn');
        const confirmMuqavileBtn = document.getElementById('confirmMuqavileBtn');
        const confirmBtnYes = document.getElementById('confirmBtnYes'); 
        const confirmBtnNo = document.getElementById('confirmBtnNo'); 
        const tarixcePrintBtn = document.getElementById('tarixce-print-btn');
        
        // === QLOBAL DƏYİŞƏNLƏR ===
        let musteriler = JSON.parse(localStorage.getItem('musteriler')) || [];
        let magazaAdi = localStorage.getItem('magazaAdi') || 'Mağaza Adı Daxil Edilməyib';
        
        let passwords = JSON.parse(localStorage.getItem('passwords')) || {
            delete: "1234",
            edit: "1234"
        };
        
        let muveqqetiData = null;
        let sortState = { column: 'ad', direction: 'asc' };
        let currentConfirmCallback = null;
        
        const interestRates = { 3: 0.08, 6: 0.08, 9: 0.08, 12: 0.15, 18: 0.20 };

        // === KÖMƏKÇİ FUNKSİYALAR ===
        
        // Müştərinin tam adını qaytarır
        function getFullName(musteri) {
            if (!musteri) return '';
            return `${musteri.ad || ''} ${musteri.soyad || ''} ${musteri.ataAdi || ''}`.trim();
        }

        // Yeni unikal müştəri kodu yaradır
        function generateCustomerCode() {
            let lastId = parseInt(localStorage.getItem('lastCustomerId')) || 0;
            lastId++;
            localStorage.setItem('lastCustomerId', lastId);
            return 'M' + String(lastId).padStart(5, '0');
        }

        // Köhnə datanı yeni struktura uyğunlaşdırır
        function migrateData() {
            let dataMigrated = false;
            musteriler.forEach(musteri => {
                if (musteri.adSoyadAta && !musteri.ad) {
                    const parts = musteri.adSoyadAta.split(' ');
                    musteri.ad = parts[0] || '';
                    musteri.soyad = parts[1] || '';
                    musteri.ataAdi = parts[2] || '';
                    musteri.cins = musteri.cins || 'Kişi'; // Default
                    delete musteri.adSoyadAta;
                    dataMigrated = true;
                }
                 if (!musteri.musteriKodu) {
                    musteri.musteriKodu = generateCustomerCode();
                    dataMigrated = true;
                }
            });
            if (dataMigrated) {
                console.log("Data uğurla yeni formata keçirildi.");
                saveAndRender();
            }
        }
        
        // === HADİSƏ DİNLƏYİCİLƏRİ (EVENT LISTENERS) ===

        if (dashboardCollapsible) {
            dashboardCollapsible.querySelector('.collapsible-header').addEventListener('click', () => {
                dashboardCollapsible.classList.toggle('collapsed');
            });
        }
        
        document.querySelectorAll('.numeric-input').forEach(input => {
            input.addEventListener('input', function(e) { this.value = this.value.replace(/[^0-9]/g, ''); });
        });
        
        document.querySelectorAll('.nav-item.has-submenu > a').forEach(menuLink => {
            menuLink.addEventListener('click', (e) => {
                e.preventDefault();
                const parentItem = menuLink.parentElement;
                
                document.querySelectorAll('.nav-item.has-submenu.submenu-open').forEach(openItem => {
                    if(openItem !== parentItem) {
                        openItem.classList.remove('submenu-open');
                    }
                });

                parentItem.classList.toggle('submenu-open');
            });
        });

        navItems.forEach(item => {
            const link = item.querySelector('a');
            const targetId = item.getAttribute('data-target');
            if(!targetId) return;
            
            link.addEventListener('click', (e) => {
                e.preventDefault();

                const currentlyActivePage = document.querySelector('.page.active');
                if(currentlyActivePage){
                    switch(currentlyActivePage.id) {
                        case 'nagd-satis-sehifesi':
                            resetNagdPage();
                            break;
                        case 'yeni-kredit-sehifesi':
                            resetKreditPage();
                            break;
                        case 'kassa-medaxil-sehifesi':
                            resetKassaSearchForm();
                            break;
                    }
                }
                
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                
                item.classList.add('active');
                if (item.closest('.submenu')) {
                   item.closest('.has-submenu').classList.add('active');
                }
                
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');

                if (targetId === 'kassa-gun-sonu-sehifesi') {
                    renderCurrentDayReport();
                }

                if (targetId === 'satis-hesabati-sehifesi') {
                    setDefaultDatesAndFilter('satisHesabatiBaslamaTarixi', 'satisHesabatiBitmeTarixi', handleSatisHesabatiFilter);
                }
                if (targetId === 'kassa-hesabati-sehifesi') {
                    setDefaultDatesAndFilter('kassaHesabatiBaslamaTarixi', 'kassaHesabatiBitmeTarixi', handleKassaHesabatiFilter);
                }
                if (targetId === 'bank-odenisleri-sehifesi') {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('bankOdenisleriTarix').value = today;
                    handleBankOdenisleriFilter(); 
                }
                
                if (targetId === 'magaza-adi-sehifesi') {
                    magazaAdiInput.value = magazaAdi;
                }

                if (item.closest('.submenu')) {
                    item.closest('.has-submenu').classList.remove('submenu-open');
                }
            });
        });


        [nagdQiymetInput, kreditMuddetiSelect, ilkinOdenisInput].forEach(el => {
            el.addEventListener('input', calculateKreditDetails);
        });

        kreditFormu.addEventListener('submit', handleKreditFormSubmit);
        
        confirmMuqavileBtn.addEventListener('click', () => {
            if (muveqqetiData && muveqqetiData.faktura) {
                const { customer, faktura } = muveqqetiData;
                let isNewCustomer = false;

                let existingMusteriIndex = musteriler.findIndex(m => m.id === customer.id);

                if (existingMusteriIndex > -1) {
                    if (!musteriler[existingMusteriIndex].fakturalar) {
                        musteriler[existingMusteriIndex].fakturalar = [];
                    }
                    musteriler[existingMusteriIndex].fakturalar.push(faktura);
                } else {
                    isNewCustomer = true;
                    customer.fakturalar = [faktura];
                    musteriler.push(customer);
                }
                
                saveAndRender();

                if (isNewCustomer) {
                    alert('Yeni müştəri uğurla əlavə edildi!');
                }

                kreditFormu.reset();
                resetKreditFormCustomer();
                calculateKreditDetails();
                muqavileModal.style.display = 'none';
                muveqqetiData = null;
            } else {
                alert("Xəta: Müqavilə məlumatları tapılmadı.");
            }
        });

        editMusteriFormu.addEventListener('submit', (e) => {
            e.preventDefault();
            
            showConfirm('Dəyişiklikləri Yadda Saxla', 'Müştərinin şəxsi məlumatlarında edilən dəyişiklikləri yadda saxlamağa əminsiniz?', () => {
                const id = parseInt(document.getElementById('editMusteriId').value);
                const musteriIndex = musteriler.findIndex(m => m.id === id);
                
                if (musteriIndex > -1) {
                    musteriler[musteriIndex].ad = document.getElementById('editAd').value;
                    musteriler[musteriIndex].soyad = document.getElementById('editSoyad').value;
                    musteriler[musteriIndex].ataAdi = document.getElementById('editAtaAdi').value;
                    musteriler[musteriIndex].cins = document.getElementById('editCins').value;
                    musteriler[musteriIndex].finKod = document.getElementById('editFinKod').value.toUpperCase();
                    musteriler[musteriIndex].vesiqeSeria = document.getElementById('editVesiqeSeria').value + ' ' + document.getElementById('editVesiqeNomre').value;
                    musteriler[musteriIndex].nomreler = [ document.getElementById('editMobil1').value, document.getElementById('editMobil2').value, document.getElementById('editMobil3').value ].filter(n => n);
                    
                    saveAndRender();
                    editModal.style.display = 'none';
                    alert('Müştəri məlumatları uğurla yeniləndi!');
                }
            });
        });
        
        sifrelerForm.addEventListener('submit', handleChangePassword);
        sifrelerFormEdit.addEventListener('submit', handleChangePassword);
        
        magazaAdiFormu.addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = magazaAdiInput.value.trim();
            if (newName) {
                magazaAdi = newName;
                localStorage.setItem('magazaAdi', magazaAdi);
                alert('Mağaza adı uğurla yadda saxlanıldı!');
            } else {
                alert('Mağaza adı boş ola bilməz.');
            }
        });

        showDeletePassFormBtn.addEventListener('click', () => {
            passwordModalTitle.textContent = "Silmə Şifrəsini Dəyiş";
            deletePassFormContainer.style.display = 'block';
            editPassFormContainer.style.display = 'none';
            passwordChangeModal.style.display = 'block';
        });

        showEditPassFormBtn.addEventListener('click', () => {
            passwordModalTitle.textContent = "Düzəliş Şifrəsini Dəyiş";
            deletePassFormContainer.style.display = 'none';
            editPassFormContainer.style.display = 'block';
            passwordChangeModal.style.display = 'block';
        });

        closePasswordChangeModal.onclick = () => {
            passwordChangeModal.style.display = 'none';
        };

        kassaAxtarFormu.addEventListener('submit', handleKassaSearch);
        
        satisHesabatiFormu.addEventListener('submit', handleSatisHesabatiFilter);
        kassaHesabatiFormu.addEventListener('submit', handleKassaHesabatiFilter);
        bankOdenisleriFormu.addEventListener('submit', handleBankOdenisleriFilter);

        yeniMusteriCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            yeniMusteriFormu.style.display = isChecked ? 'block' : 'none';
            movcudMusteriFormu.style.display = isChecked ? 'none' : 'block';
            resetNagdFormCustomer();
        });

        nagdMusteriAxtarBtn.addEventListener('click', handleNagdMusteriSearch);
        nagdMusteriAxtarCedveli.addEventListener('click', handleSelectNagdMusteri);
        nagdFormu.addEventListener('submit', handleNagdSubmit);
        
        yeniKreditMusteriCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            yeniKreditMusteriFormu.style.display = isChecked ? 'block' : 'none';
            movcudKreditMusteriFormu.style.display = isChecked ? 'none' : 'block';
            toggleKreditFormRequired(!isChecked);
            if (!isChecked) {
              resetKreditFormCustomer(false);
            }
        });
        kreditMusteriAxtarBtn.addEventListener('click', handleKreditMusteriSearch);
        kreditMusteriAxtarCedveli.addEventListener('click', handleSelectKreditMusteri);

        searchBox.addEventListener('keyup', () => renderMusteriler());
        musteriCedveli.addEventListener('click', handleTableActions);
        kassaAxtarCedveli.addEventListener('click', handleTableActions);
        document.getElementById('fakturaTarixcesiBody').addEventListener('click', handleFakturaTarixcesiActions);
        document.getElementById('tarixceCedveliBody').addEventListener('click', handleTarixceActions);
        tableHeaders.forEach(th => { if(th.dataset.sort) th.addEventListener('click', handleSort) });

        odenisFormu.addEventListener('submit', (e) => {
            e.preventDefault();
            const odenilenMebleg = parseFloat(document.getElementById('odenilenMebleg').value);
            
            if (odenilenMebleg <= 0) {
                alert("Ödəniş məbləği 0-dan böyük olmalıdır.");
                return;
            }
            
            showConfirm(
                'Ödənişi Təsdiqlə', 
                `${odenilenMebleg.toFixed(2)} AZN məbləğində ödənişi təsdiqləyirsiniz?`, 
                processPayment
            );
        });

        confirmBtnYes.addEventListener('click', () => {
            if (currentConfirmCallback) {
                currentConfirmCallback();
            }
            confirmModal.style.display = 'none';
        });

        confirmBtnNo.addEventListener('click', () => {
            confirmModal.style.display = 'none';
        });
        
        const odenisUsuluSelect = document.getElementById('odenisUsulu');
        const mixedPaymentDiv = document.getElementById('mixedPaymentDiv');
        const odenilenMeblegInput = document.getElementById('odenilenMebleg');
        const odenisKartInput = document.getElementById('odenisKartMebleg');
        const odenisNagdInput = document.getElementById('odenisNagdMebleg');

        odenisUsuluSelect.addEventListener('change', () => {
            if (odenisUsuluSelect.value === 'Kart/Nağd') {
                mixedPaymentDiv.style.display = 'block';
                odenilenMeblegInput.readOnly = true;
                const kart = parseFloat(odenisKartInput.value) || 0;
                const nagd = parseFloat(odenisNagdInput.value) || 0;
                odenilenMeblegInput.value = (kart + nagd).toFixed(2);
            } else {
                mixedPaymentDiv.style.display = 'none';
                odenilenMeblegInput.readOnly = false;
            }
        });

        [odenisKartInput, odenisNagdInput].forEach(input => {
            input.addEventListener('input', () => {
                if (odenisUsuluSelect.value === 'Kart/Nağd') {
                    const kart = parseFloat(odenisKartInput.value) || 0;
                    const nagd = parseFloat(odenisNagdInput.value) || 0;
                    odenilenMeblegInput.value = (kart + nagd).toFixed(2);
                }
            });
        });

        const nagdOdenisUsuluSelect = document.getElementById('nagdOdenisUsulu');
        const nagdMixedPaymentDiv = document.getElementById('nagdMixedPaymentDiv');
        const nagdMehsulQiymetiInput = document.getElementById('nagdMehsulQiymeti');
        const nagdKartInput = document.getElementById('nagdKartMebleg');
        const nagdNagdInput = document.getElementById('nagdNagdMebleg');

        nagdOdenisUsuluSelect.addEventListener('change', () => {
            if (nagdOdenisUsuluSelect.value === 'Kart/Nağd') {
                nagdMixedPaymentDiv.style.display = 'block';
                nagdMehsulQiymetiInput.readOnly = true;
                const kart = parseFloat(nagdKartInput.value) || 0;
                const nagd = parseFloat(nagdNagdInput.value) || 0;
                nagdMehsulQiymetiInput.value = (kart + nagd).toFixed(2);
            } else {
                nagdMixedPaymentDiv.style.display = 'none';
                nagdMehsulQiymetiInput.readOnly = false;
            }
        });

        [nagdKartInput, nagdNagdInput].forEach(input => {
            input.addEventListener('input', () => {
                if (nagdOdenisUsuluSelect.value === 'Kart/Nağd') {
                    const kart = parseFloat(nagdKartInput.value) || 0;
                    const nagd = parseFloat(nagdNagdInput.value) || 0;
                    nagdMehsulQiymetiInput.value = (kart + nagd).toFixed(2);
                }
            });
        });

        closeOdenisModal.onclick = () => odenisModal.style.display = 'none';
        closeCekModal.onclick = () => cekModal.style.display = 'none';
        closeNagdCekModal.onclick = () => nagdCekModal.style.display = 'none';
        closeEditModal.onclick = () => editModal.style.display = 'none';
        closeMuqavileModal.onclick = () => muqavileModal.style.display = 'none';
        closeTarixceModal.onclick = () => odenisTarixcesiModal.style.display = 'none';
        closeDetailsModal.onclick = () => detailsModal.style.display = 'none';
        
        printCekBtn.addEventListener('click', () => window.print());
        printNagdCekBtn.addEventListener('click', () => window.print());
        printMuqavileBtn.addEventListener('click', () => window.print());
        tarixcePrintBtn.addEventListener('click', () => window.print());

        window.onclick = (event) => {
            const modals = [odenisModal, cekModal, nagdCekModal, editModal, muqavileModal, odenisTarixcesiModal, detailsModal, confirmModal, passwordChangeModal];
            if (modals.includes(event.target)) {
                event.target.style.display = 'none';
            }
        };

        // === FUNKSİYALAR ===
        
        function setDefaultDatesAndFilter(startId, endId, filterFunction) {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById(startId).value = today;
            document.getElementById(endId).value = today;
            filterFunction(new Event('submit'));
        }

        function handleSatisHesabatiFilter(e) {
            if(e) e.preventDefault();
            const startDate = document.getElementById('satisHesabatiBaslamaTarixi').value;
            const endDate = document.getElementById('satisHesabatiBitmeTarixi').value;
            const tbody = document.getElementById('satisHesabatiCedveli');
            
            if (!startDate || !endDate) {
                alert("Zəhmət olmasa, başlama və bitmə tarixlərini seçin.");
                return;
            }
            
            const start = new Date(startDate);
            start.setHours(0,0,0,0);
            const end = new Date(endDate);
            end.setHours(23,59,59,999);

            tbody.innerHTML = '';
            let found = false;

            musteriler.forEach(musteri => {
                (musteri.fakturalar || []).forEach(faktura => {
                    if (faktura.tip === 'nagd') {
                        const fakturaDate = new Date(faktura.tarix);
                        if (fakturaDate >= start && fakturaDate <= end) {
                            found = true;
                            const tr = `
                                <tr>
                                    <td>${faktura.fakturaId}</td>
                                    <td>${fakturaDate.toLocaleString('az-AZ')}</td>
                                    <td>${getFullName(musteri)} (${musteri.musteriKodu})</td>
                                    <td>${faktura.mebleg.toFixed(2)}</td>
                                    <td>${faktura.usulText || faktura.usul}</td>
                                </tr>
                            `;
                            tbody.innerHTML += tr;
                        }
                    }
                });
            });

            if (!found) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Seçilmiş tarix aralığında nağd satış tapılmadı.</td></tr>`;
            }
        }

        function handleKassaHesabatiFilter(e) {
            if(e) e.preventDefault();
            const startDate = document.getElementById('kassaHesabatiBaslamaTarixi').value;
            const endDate = document.getElementById('kassaHesabatiBitmeTarixi').value;
            const odenisUsulu = document.getElementById('kassaHesabatiOdenisUsulu').value;
            const tbody = document.getElementById('kassaHesabatiCedveli');
            
            if (!startDate || !endDate) {
                alert("Zəhmət olmasa, başlama və bitmə tarixlərini seçin.");
                return;
            }
            
            const start = new Date(startDate);
            start.setHours(0,0,0,0);
            const end = new Date(endDate);
            end.setHours(23,59,59,999);
            
            tbody.innerHTML = '';
            let found = false;

            musteriler.forEach(musteri => {
                (musteri.fakturalar || []).forEach(faktura => {
                    if (faktura.tip === 'kredit' && faktura.odenisQrafiki) {
                        faktura.odenisQrafiki.forEach(ay => {
                            (ay.odenisler || []).forEach(odenis => {
                                const odenisDate = new Date(odenis.tarix);
                                const usulMatch = (odenisUsulu === 'Hamisi') || (odenis.usul === odenisUsulu);

                                if (odenisDate >= start && odenisDate <= end && usulMatch) {
                                    found = true;
                                    const tr = `
                                        <tr>
                                            <td>${odenis.id}</td>
                                            <td>${odenisDate.toLocaleString('az-AZ')}</td>
                                            <td>${getFullName(musteri)} (${musteri.musteriKodu})</td>
                                            <td>${faktura.mehsulAdi}</td>
                                            <td>${odenis.mebleg.toFixed(2)}</td>
                                            <td>${odenis.usulText || odenis.usul}</td>
                                        </tr>
                                    `;
                                    tbody.innerHTML += tr;
                                }
                            });
                        });
                    }
                });
            });

            if (!found) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Seçilmiş filterlərə uyğun kredit ödənişi tapılmadı.</td></tr>`;
            }
        }

        function handleBankOdenisleriFilter(e) {
            if(e) e.preventDefault();
            const selectedDateStr = document.getElementById('bankOdenisleriTarix').value;
            const totalEl = document.getElementById('bankOdenisleriCemi');

            if (!selectedDateStr) {
                alert("Zəhmət olmasa, bir tarix seçin.");
                return;
            }
            
            const selectedDate = new Date(selectedDateStr);
            let totalKartOdenis = 0;

            musteriler.forEach(musteri => {
                (musteri.fakturalar || []).forEach(faktura => {
                    const fakturaDate = new Date(faktura.tarix);

                    if (faktura.tip === 'nagd' && isSameDay(fakturaDate, selectedDate)) {
                        if (faktura.usul === 'Kart ilə') {
                            totalKartOdenis += faktura.mebleg;
                        } else if (faktura.usul === 'Kart/Nağd') {
                            totalKartOdenis += faktura.meblegKart || 0;
                        }
                    }
                    
                    else if (faktura.tip === 'kredit' && faktura.odenisQrafiki) {
                        faktura.odenisQrafiki.forEach(ay => {
                            (ay.odenisler || []).forEach(odenis => {
                                const odenisDate = new Date(odenis.tarix);
                                if (isSameDay(odenisDate, selectedDate)) {
                                    if (odenis.usul === 'Kart') {
                                        totalKartOdenis += odenis.mebleg;
                                    } else if (odenis.usul === 'Kart/Nağd') {
                                        totalKartOdenis += odenis.meblegKart || 0;
                                    }
                                }
                            });
                        });
                    }
                });
            });
            
            totalEl.textContent = `${totalKartOdenis.toFixed(2)} AZN`;
        }
        
        function resetKassaSearchForm() {
            kassaAxtarFormu.reset();
            kassaAxtarNeticeleri.style.display = 'none';
            kassaAxtarCedveli.innerHTML = '';
        }

        function resetNagdPage() {
            nagdFormu.reset();
            resetNagdFormCustomer(); 
            yeniMusteriCheckbox.checked = false;
            const event = new Event('change');
            yeniMusteriCheckbox.dispatchEvent(event);
            nagdMixedPaymentDiv.style.display = 'none';
            nagdMehsulQiymetiInput.readOnly = false;
        }

        function resetKreditPage() {
            kreditFormu.reset();
            resetKreditFormCustomer();
            calculateKreditDetails();
            yeniKreditMusteriCheckbox.checked = true;
            const event = new Event('change');
            yeniKreditMusteriCheckbox.dispatchEvent(event);
        }


        function savePasswords() {
            localStorage.setItem('passwords', JSON.stringify(passwords));
        }

        function handleChangePassword(e) {
            e.preventDefault();
            const form = e.target.closest('form');
            const passType = form.querySelector('button[type="submit"]').dataset.passType;
            const currentPassInput = document.getElementById(`${passType}-current-pass`);
            const newPassInput = document.getElementById(`${passType}-new-pass`);
            const feedbackEl = document.getElementById(`${passType}-feedback`);

            const currentPass = currentPassInput.value;
            const newPass = newPassInput.value;

            if (currentPass === passwords[passType]) {
                if(newPass.length < 4){
                    feedbackEl.textContent = "Yeni şifrə ən az 4 simvol olmalıdır.";
                    feedbackEl.style.color = 'var(--danger-color)';
                    return;
                }
                passwords[passType] = newPass;
                savePasswords();
                feedbackEl.textContent = "Şifrə uğurla dəyişdirildi!";
                feedbackEl.style.color = 'var(--success-color)';
                form.reset();
                setTimeout(() => {
                   passwordChangeModal.style.display = 'none';
                   feedbackEl.textContent = '';
                }, 1500);
            } else {
                feedbackEl.textContent = "Cari şifrə yanlışdır!";
                feedbackEl.style.color = 'var(--danger-color)';
            }
            setTimeout(() => feedbackEl.textContent = '', 3000);
        }
        
        function handleKassaSearch(e) {
            e.preventDefault();
            const searchBtn = e.target.closest('form').querySelector('button[type="submit"]');
            const searchIcon = searchBtn.querySelector('i');
            const originalIconClass = 'fas fa-search';
            
            searchIcon.className = 'fas fa-spinner fa-spin';
            searchBtn.disabled = true;

            setTimeout(() => {
                const ad = document.getElementById('kassaAxtarAd').value.toLowerCase().trim();
                const fin = document.getElementById('kassaAxtarFin').value.toLowerCase().trim();
                const tel = document.getElementById('kassaAxtarTel').value.trim();
                
                if (!ad && !fin && !tel) {
                    alert("Axtarış üçün ən az bir xananı doldurun.");
                    searchIcon.className = originalIconClass;
                    searchBtn.disabled = false;
                    return;
                }

                const tapilanlar = musteriler.filter(m => {
                    const adMatch = ad && (getFullName(m).toLowerCase().includes(ad) || m.musteriKodu.toLowerCase().includes(ad));
                    const finMatch = fin && m.finKod.toLowerCase().includes(fin);
                    const telMatch = tel && m.nomreler.some(n => n.includes(tel));
                    return adMatch || finMatch || telMatch;
                });

                kassaAxtarCedveli.innerHTML = '';
                let resultsFound = false;
                if (tapilanlar.length > 0) {
                    tapilanlar.forEach(musteri => {
                        const aktivKreditler = (musteri.fakturalar || []).filter(f => {
                            if (f.tip !== 'kredit') return false;
                            return getFakturaQaliqBorc(f) > 0.01;
                        });

                        if (aktivKreditler.length === 0) {
                            const tr = `<tr>
                                            <td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td>
                                            <td colspan="3">Bu müştərinin aktiv kredit borcu yoxdur.</td>
                                            <td><button class="action-btn view-details-btn" data-id="${musteri.id}"><i class="fas fa-eye"></i> Bax</button></td>
                                        </tr>`;
                            kassaAxtarCedveli.innerHTML += tr;
                        } else {
                            aktivKreditler.forEach(faktura => {
                                resultsFound = true;
                                const qaliqBorc = getFakturaQaliqBorc(faktura);
                                const novbetiOdenisAyi = faktura.odenisQrafiki.find(ay => (ay.odenmeli - ay.odenmis) > 0.01);
                                const novbetiTarix = novbetiOdenisAyi ? new Date(novbetiOdenisAyi.tarix).toLocaleDateString('az-AZ') : 'Bitib';

                                const tr = `
                                    <tr data-id="${musteri.id}" data-faktura-id="${faktura.fakturaId}">
                                        <td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td>
                                        <td>${faktura.mehsulAdi}</td>
                                        <td>${qaliqBorc.toFixed(2)} AZN</td>
                                        <td>${novbetiTarix}</td>
                                        <td>
                                            <button class="action-btn pay-btn"><i class="fas fa-dollar-sign"></i> Ödə</button>
                                            <button class="action-btn details-btn"><i class="fas fa-calendar-alt"></i></button>
                                        </td>
                                    </tr>`;
                                kassaAxtarCedveli.innerHTML += tr;
                            });
                        }
                    });
                    kassaAxtarNeticeleri.style.display = 'block';
                } 
                
                if (!resultsFound && tapilanlar.length === 0) {
                    kassaAxtarCedveli.innerHTML = `<tr><td colspan="5" style="text-align:center;">Axtarışa uyğun müştəri tapılmadı.</td></tr>`;
                    kassaAxtarNeticeleri.style.display = 'block';
                }

                searchIcon.className = originalIconClass;
                searchBtn.disabled = false;
            }, 500);
        }
        
        function resetNagdFormCustomer() {
            document.getElementById('nagdMusteriId').value = '';
            selectedCustomerInfo.style.display = 'none';
            customerSearchArea.style.display = 'block';
            nagdMusteriAxtarInput.value = '';
            nagdMusteriAxtarNeticeleri.style.display = 'none';
            document.getElementById('nagdAd').value = '';
            document.getElementById('nagdSoyad').value = '';
            document.getElementById('nagdAtaAdi').value = '';
            document.getElementById('nagdFinKod').value = '';
            document.getElementById('nagdMobilNomre').value = '';
        }

        function handleNagdMusteriSearch() {
            const searchTerm = nagdMusteriAxtarInput.value.toLowerCase().trim();
            if (searchTerm.length < 2) {
                nagdMusteriAxtarNeticeleri.style.display = 'none';
                return;
            }

            const tapilanlar = musteriler.filter(m => 
                (getFullName(m).toLowerCase().includes(searchTerm)) ||
                (m.musteriKodu && m.musteriKodu.toLowerCase().includes(searchTerm)) ||
                (m.finKod && m.finKod.toLowerCase().includes(searchTerm)) ||
                (m.nomreler && m.nomreler.some(n => n.includes(searchTerm)))
            );

            nagdMusteriAxtarCedveli.innerHTML = '';
            if (tapilanlar.length > 0) {
                tapilanlar.forEach(musteri => {
                    const tr = `
                        <tr>
                            <td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td>
                            <td>${musteri.finKod || '---'}</td>
                            <td>${(musteri.nomreler || []).join(', ')}</td>
                            <td><button type="button" class="action-btn select-customer-btn" data-id="${musteri.id}">Seç</button></td>
                        </tr>`;
                    nagdMusteriAxtarCedveli.innerHTML += tr;
                });
                nagdMusteriAxtarNeticeleri.style.display = 'block';
            } else {
                nagdMusteriAxtarCedveli.innerHTML = `<tr><td colspan="4" style="text-align:center;">Müştəri tapılmadı.</td></tr>`;
                nagdMusteriAxtarNeticeleri.style.display = 'block';
            }
        }
        
        function handleSelectNagdMusteri(e) {
            if (e.target.classList.contains('select-customer-btn')) {
                const id = parseInt(e.target.dataset.id);
                const musteri = musteriler.find(m => m.id === id);
                if (musteri) {
                    document.getElementById('nagdMusteriId').value = musteri.id;
                    selectedCustomerInfo.innerHTML = `<p><strong>Seçilmiş Müştəri:</strong> ${getFullName(musteri)} (${musteri.musteriKodu}) <button type="button" class="action-btn" onclick="resetNagdFormCustomer();">Ləğv et</button></p>`;
                    selectedCustomerInfo.style.display = 'block';
                    customerSearchArea.style.display = 'none';
                    nagdMusteriAxtarNeticeleri.style.display = 'none';
                }
            }
        }
        
        function handleNagdSubmit(e) {
            e.preventDefault();
            const satisMelumatlari = {
                mehsul: document.getElementById('nagdMehsulAdi').value,
                qiymet: parseFloat(document.getElementById('nagdMehsulQiymeti').value),
                usul: document.getElementById('nagdOdenisUsulu').value,
                yeniMusteridir: yeniMusteriCheckbox.checked,
                secilmisMusteriId: parseInt(document.getElementById('nagdMusteriId').value) || null,
                yeniMusteriMelumatlari: {
                    ad: document.getElementById('nagdAd').value,
                    soyad: document.getElementById('nagdSoyad').value,
                    ataAdi: document.getElementById('nagdAtaAdi').value,
                    cins: document.getElementById('nagdCins').value,
                    finKod: document.getElementById('nagdFinKod').value.toUpperCase(),
                    nomre: document.getElementById('nagdMobilNomre').value ? document.getElementById('nagdMobilPrefix').value + document.getElementById('nagdMobilNomre').value : ''
                }
            };
            
            if (!satisMelumatlari.mehsul || isNaN(satisMelumatlari.qiymet) || satisMelumatlari.qiymet <= 0) {
                alert('Məhsul adı və qiyməti düzgün daxil edilməlidir.');
                return;
            }

            if (satisMelumatlari.yeniMusteridir && (!satisMelumatlari.yeniMusteriMelumatlari.ad || !satisMelumatlari.yeniMusteriMelumatlari.soyad)) {
                alert('Yeni müştərinin adını və soyadını daxil edin.');
                return;
            }
            
            if (!satisMelumatlari.yeniMusteridir && !satisMelumatlari.secilmisMusteriId) {
                alert('Zəhmət olmasa, mövcud müştərini seçin və ya yeni müştəri kimi qeyd edin.');
                return;
            }
            
            showConfirm('Satışı Təsdiqlə', 'Bu nağd satışı təsdiqləyirsiniz?', () => processNagdSale(satisMelumatlari));
        }
        
        function processNagdSale(satis) {
            let musteriToUpdate;
            let isNewCustomer = false;

            if (!satis.yeniMusteridir && satis.secilmisMusteriId) {
                musteriToUpdate = musteriler.find(m => m.id === satis.secilmisMusteriId);
            } else {
                isNewCustomer = true;
                const fin = satis.yeniMusteriMelumatlari.finKod;
                let existingMusteriByFin = null;
                if (fin) {
                    existingMusteriByFin = musteriler.find(m => m.finKod === fin);
                }

                if (existingMusteriByFin) {
                    isNewCustomer = false; // FIN eynidirsə, yeni deyil, mövcud müştəridir.
                    musteriToUpdate = existingMusteriByFin;
                } else {
                    const newCustomer = {
                        id: Date.now(),
                        musteriKodu: generateCustomerCode(),
                        ad: satis.yeniMusteriMelumatlari.ad,
                        soyad: satis.yeniMusteriMelumatlari.soyad,
                        ataAdi: satis.yeniMusteriMelumatlari.ataAdi,
                        cins: satis.yeniMusteriMelumatlari.cins,
                        finKod: satis.yeniMusteriMelumatlari.finKod || '',
                        vesiqeSeria: '',
                        nomreler: satis.yeniMusteriMelumatlari.nomre ? [satis.yeniMusteriMelumatlari.nomre] : [],
                        fakturalar: []
                    };
                    musteriler.push(newCustomer);
                    musteriToUpdate = newCustomer;
                }
            }

            if (!musteriToUpdate) {
                alert("Xəta: Müştəri tapılmadı və ya yaradıla bilmədi.");
                return;
            }
            
            const yeniFaktura = {
                fakturaId: "NAGD_" + Date.now(),
                tip: "nagd",
                tarix: new Date().toISOString(),
                mehsul: satis.mehsul,
                mebleg: satis.qiymet,
                usul: satis.usul
            };
            
            if (satis.usul === 'Kart/Nağd') {
                const kartMebleg = parseFloat(document.getElementById('nagdKartMebleg').value) || 0;
                const nagdMebleg = parseFloat(document.getElementById('nagdNagdMebleg').value) || 0;
                if(Math.abs((kartMebleg + nagdMebleg) - satis.qiymet) > 0.01){
                    alert('Kart və nağd məbləğlərin cəmi satış qiymətinə bərabər deyil!');
                    return;
                }
                yeniFaktura.meblegKart = kartMebleg;
                yeniFaktura.meblegNagd = nagdMebleg;
                yeniFaktura.usulText = `Kart (${kartMebleg.toFixed(2)}) + Nağd (${nagdMebleg.toFixed(2)})`;
            }
            
            if (!musteriToUpdate.fakturalar) {
                musteriToUpdate.fakturalar = [];
            }
            musteriToUpdate.fakturalar.push(yeniFaktura);
            
            saveAndRender();
            
            if(isNewCustomer) {
                 alert("Yeni müştəri uğurla əlavə edildi!");
            }
            
            openNagdCekModal(musteriToUpdate, yeniFaktura);
            nagdFormu.reset();
            resetNagdFormCustomer();
            yeniMusteriCheckbox.checked = false;
            yeniMusteriFormu.style.display = 'none';
            movcudMusteriFormu.style.display = 'block';
            nagdMixedPaymentDiv.style.display = 'none';
            nagdMehsulQiymetiInput.readOnly = false;
        }


        function openNagdCekModal(musteri, faktura) {
            document.getElementById('nagdCekSatici').textContent = magazaAdi;
            document.getElementById('nagdCekId').textContent = faktura.fakturaId;
            document.getElementById('nagdCekTarix').textContent = new Date(faktura.tarix).toLocaleString('az-AZ');
            document.getElementById('nagdCekMusteriAdi').textContent = `${getFullName(musteri)} (${musteri.musteriKodu})`;
            document.getElementById('nagdCekMehsulAdi').textContent = faktura.mehsul;
            document.getElementById('nagdCekOdenenMebleg').textContent = faktura.mebleg.toFixed(2);
            document.getElementById('nagdCekOdenisUsulu').textContent = faktura.usulText || faktura.usul;
            nagdCekModal.style.display = 'block';
        }

        function resetKreditFormCustomer(resetCheckbox = true) {
            document.getElementById('kreditMusteriId').value = '';
            selectedKreditCustomerInfo.style.display = 'none';
            kreditCustomerSearchArea.style.display = 'block';
            kreditMusteriAxtarInput.value = '';
            kreditMusteriAxtarNeticeleri.style.display = 'none';
            
            const fieldsToReset = ['ad', 'soyad', 'ataAdi', 'finKod', 'vesiqeNomre', 'mobil1-nomre', 'mobil2-nomre', 'mobil3-nomre'];
            fieldsToReset.forEach(id => {
                const el = document.getElementById(id);
                el.value = '';
                el.readOnly = false;
            });
            document.getElementById('vesiqeSeria').disabled = false;
            document.getElementById('mobil1-prefix').disabled = false;
            document.getElementById('mobil2-prefix').disabled = false;
            document.getElementById('mobil3-prefix').disabled = false;
            
            if(resetCheckbox) {
                yeniKreditMusteriCheckbox.checked = true;
                yeniKreditMusteriFormu.style.display = 'block';
                movcudKreditMusteriFormu.style.display = 'none';
                toggleKreditFormRequired(false);
            }
        }
        
        function handleKreditMusteriSearch() {
            const searchTerm = kreditMusteriAxtarInput.value.toLowerCase().trim();
            if (searchTerm.length < 2) {
                kreditMusteriAxtarNeticeleri.style.display = 'none';
                return;
            }
            const tapilanlar = musteriler.filter(m => 
                (getFullName(m).toLowerCase().includes(searchTerm)) ||
                (m.musteriKodu && m.musteriKodu.toLowerCase().includes(searchTerm)) ||
                (m.finKod && m.finKod.toLowerCase().includes(searchTerm)) ||
                (m.nomreler && m.nomreler.some(n => n.includes(searchTerm)))
            );
            kreditMusteriAxtarCedveli.innerHTML = '';
            if (tapilanlar.length > 0) {
                tapilanlar.forEach(musteri => {
                    const tr = `
                        <tr>
                            <td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td>
                            <td>${musteri.finKod || '---'}</td>
                            <td>${(musteri.nomreler || []).join(', ')}</td>
                            <td><button type="button" class="action-btn select-customer-btn" data-id="${musteri.id}">Seç</button></td>
                        </tr>`;
                    kreditMusteriAxtarCedveli.innerHTML += tr;
                });
                kreditMusteriAxtarNeticeleri.style.display = 'block';
            } else {
                kreditMusteriAxtarCedveli.innerHTML = `<tr><td colspan="4" style="text-align:center;">Müştəri tapılmadı.</td></tr>`;
                kreditMusteriAxtarNeticeleri.style.display = 'block';
            }
        }

        function handleSelectKreditMusteri(e) {
            if (e.target.classList.contains('select-customer-btn')) {
                const id = parseInt(e.target.dataset.id);
                const musteri = musteriler.find(m => m.id === id);
                if (musteri) {
                    document.getElementById('kreditMusteriId').value = musteri.id;
                    selectedKreditCustomerInfo.innerHTML = `<p><strong>Seçilmiş Müştəri:</strong> ${getFullName(musteri)} (${musteri.musteriKodu}) <button type="button" class="action-btn" onclick="resetKreditFormCustomer()">Ləğv et</button></p>`;
                    selectedKreditCustomerInfo.style.display = 'block';
                    kreditCustomerSearchArea.style.display = 'none';
                    kreditMusteriAxtarNeticeleri.style.display = 'none';
                    fillAndLockKreditForm(musteri);
                }
            }
        }

        function fillAndLockKreditForm(musteri) {
            document.getElementById('ad').value = musteri.ad;
            document.getElementById('soyad').value = musteri.soyad;
            document.getElementById('ataAdi').value = musteri.ataAdi;
            document.getElementById('cins').value = musteri.cins || 'Kişi';
            document.getElementById('finKod').value = musteri.finKod;
            
            const [seria, ...nomreParts] = (musteri.vesiqeSeria || '').split(' ');
            const nomre = nomreParts.join('');
            document.getElementById('vesiqeSeria').value = seria || 'AZE';
            document.getElementById('vesiqeNomre').value = nomre || '';

            const nomreler = musteri.nomreler || [];
            if(nomreler[0]) {
                 document.getElementById('mobil1-prefix').value = nomreler[0].substring(0, 3);
                 document.getElementById('mobil1-nomre').value = nomreler[0].substring(3);
            }
             if(nomreler[1]) {
                 document.getElementById('mobil2-prefix').value = nomreler[1].substring(0, 3);
                 document.getElementById('mobil2-nomre').value = nomreler[1].substring(3);
            }
             if(nomreler[2]) {
                 document.getElementById('mobil3-prefix').value = nomreler[2].substring(0, 3);
                 document.getElementById('mobil3-nomre').value = nomreler[2].substring(3);
            }
            
            const fieldsToLock = ['ad', 'soyad', 'ataAdi', 'finKod', 'vesiqeNomre', 'mobil1-nomre', 'mobil2-nomre', 'mobil3-nomre'];
            fieldsToLock.forEach(id => document.getElementById(id).readOnly = true);
            document.getElementById('cins').disabled = true;
            document.getElementById('vesiqeSeria').disabled = true;
            document.getElementById('mobil1-prefix').disabled = true;
            document.getElementById('mobil2-prefix').disabled = true;
            document.getElementById('mobil3-prefix').disabled = true;

            yeniKreditMusteriFormu.style.display = 'block'; 
        }
        
        function toggleKreditFormRequired(isExisting) {
            const fields = ['ad', 'soyad', 'ataAdi', 'finKod', 'vesiqeNomre', 'mobil1-nomre'];
            fields.forEach(id => {
                document.getElementById(id).required = !isExisting;
            });
        }
        
        function handleKreditFormSubmit(e) {
            e.preventDefault();
            
            const isYeniMusteri = yeniKreditMusteriCheckbox.checked;
            const secilmisMusteriId = parseInt(document.getElementById('kreditMusteriId').value) || null;

            let customerData;
            
            if (!isYeniMusteri && secilmisMusteriId) {
                customerData = musteriler.find(m => m.id === secilmisMusteriId);
                if (!customerData) {
                    alert("Seçilmiş müştəri tapılmadı. Zəhmət olmasa, yenidən seçin.");
                    return;
                }
            } else {
                customerData = {
                    id: Date.now(),
                    musteriKodu: generateCustomerCode(),
                    ad: document.getElementById('ad').value,
                    soyad: document.getElementById('soyad').value,
                    ataAdi: document.getElementById('ataAdi').value,
                    cins: document.getElementById('cins').value,
                    finKod: document.getElementById('finKod').value.toUpperCase(),
                    vesiqeSeria: document.getElementById('vesiqeSeria').value + ' ' + document.getElementById('vesiqeNomre').value,
                    nomreler: [],
                    fakturalar: []
                };
                if (document.getElementById('mobil1-nomre').value) customerData.nomreler.push(document.getElementById('mobil1-prefix').value + document.getElementById('mobil1-nomre').value);
                if (document.getElementById('mobil2-nomre').value) customerData.nomreler.push(document.getElementById('mobil2-prefix').value + document.getElementById('mobil2-nomre').value);
                if (document.getElementById('mobil3-nomre').value) customerData.nomreler.push(document.getElementById('mobil3-prefix').value + document.getElementById('mobil3-nomre').value);
            }

            const ayliqOdenis = parseFloat(ayliqOdenisInput.value);
            const kreditMuddeti = parseInt(kreditMuddetiSelect.value);
            
            const odenisQrafiki = [];
            let ilkOdenisTarixi = new Date();
            ilkOdenisTarixi.setMonth(ilkOdenisTarixi.getMonth() + 1);

            for(let i=0; i < kreditMuddeti; i++){
                odenisQrafiki.push({
                    ay: i + 1,
                    tarix: new Date(ilkOdenisTarixi).toISOString().split('T')[0],
                    odenmeli: ayliqOdenis,
                    odenmis: 0,
                    odenisler: []
                });
                ilkOdenisTarixi.setMonth(ilkOdenisTarixi.getMonth() + 1);
            }

            const yeniFaktura = {
                fakturaId: "KREDIT_" + Date.now(),
                tip: "kredit",
                tarix: new Date().toISOString(),
                mehsulAdi: document.getElementById('mehsulAdi').value,
                mehsulKateqoriya: document.getElementById('mehsulKateqoriya').value,
                nagdQiymet: parseFloat(nagdQiymetInput.value),
                kreditQiymeti: parseFloat(kreditQiymetiInput.value),
                ilkinOdenis: parseFloat(ilkinOdenisInput.value) || 0,
                kreditMuddeti: kreditMuddeti,
                odenisQrafiki: odenisQrafiki
            };
            
            muveqqetiData = { customer: customerData, faktura: yeniFaktura };
            openMuqavileModal(muveqqetiData);
        }

        // --- ÜMUMİ FUNKSİYALAR ---
        
        function renderCurrentDayReport() {
            let totalNagd = 0;
            let totalKart = 0;
            const selectedDate = new Date();

            musteriler.forEach(musteri => {
                if (!musteri.fakturalar) return;

                musteri.fakturalar.forEach(faktura => {
                    const fakturaDate = new Date(faktura.tarix);

                    if (faktura.tip === 'nagd' && isSameDay(fakturaDate, selectedDate)) {
                        let nagdAmount = 0;
                        let kartAmount = 0;
                        
                        if (faktura.usul === 'Nağd') {
                            nagdAmount = faktura.mebleg;
                        } else if (faktura.usul === 'Kart ilə') {
                            kartAmount = faktura.mebleg;
                        } else if (faktura.usul === 'Kart/Nağd') {
                            nagdAmount = faktura.meblegNagd || 0;
                            kartAmount = faktura.meblegKart || 0;
                        }
                        totalNagd += nagdAmount;
                        totalKart += kartAmount;
                    }
                    
                    else if (faktura.tip === 'kredit' && faktura.odenisQrafiki) {
                        faktura.odenisQrafiki.forEach(ay => {
                            if (!ay.odenisler) return;

                            ay.odenisler.forEach(odenis => {
                                const odenisDate = new Date(odenis.tarix);
                                if (isSameDay(odenisDate, selectedDate)) {
                                    let nagdAmount = 0;
                                    let kartAmount = 0;

                                    if (odenis.usul === 'Nağd') {
                                        nagdAmount = odenis.mebleg;
                                    } else if (odenis.usul === 'Kart') {
                                        kartAmount = odenis.mebleg;
                                    } else if (odenis.usul === 'Kart/Nağd') {
                                        nagdAmount = odenis.meblegNagd || 0;
                                        kartAmount = odenis.meblegKart || 0;
                                    }
                                    totalNagd += nagdAmount;
                                    totalKart += kartAmount;
                                }
                            });
                        });
                    }
                });
            });

            document.getElementById('gunSonuNagdCemi').textContent = `${totalNagd.toFixed(2)} AZN`;
            document.getElementById('gunSonuKartCemi').textContent = `${totalKart.toFixed(2)} AZN`;
            document.getElementById('gunSonuUmumiCemi').textContent = `${(totalNagd + totalKart).toFixed(2)} AZN`;
        }
        
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function showConfirm(title, text, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').textContent = text;
            currentConfirmCallback = callback;
            confirmModal.style.display = 'block';
        }
        
        function recalculatePaymentScheduleForFaktura(faktura) {
            if (!faktura || faktura.tip !== 'kredit') return;
            
            faktura.odenisQrafiki.forEach(ay => { ay.odenmis = 0; });

            const allPayments = faktura.odenisQrafiki.flatMap(ay => ay.odenisler).sort((a, b) => new Date(a.tarix) - new Date(b.tarix));
            
            faktura.odenisQrafiki.forEach(ay => ay.odenmis = 0); 

            allPayments.forEach(payment => {
                let amountToDistribute = payment.mebleg;
                for (const ay of faktura.odenisQrafiki) {
                    if (amountToDistribute <= 0) break;
                    const qaliqForMonth = ay.odenmeli - ay.odenmis;
                    if (qaliqForMonth > 0) {
                        const paidForThisMonth = Math.min(amountToDistribute, qaliqForMonth);
                        ay.odenmis += paidForThisMonth;
                        amountToDistribute -= paidForThisMonth;
                    }
                }
            });
        }
        
        function processPayment() {
            const id = parseInt(document.getElementById('modalMusteriId').value);
            const fakturaId = document.getElementById('modalFakturaId').value;
            const musteriIndex = musteriler.findIndex(m => m.id === id);
            if(musteriIndex === -1) return;

            const musteri = musteriler[musteriIndex];
            const fakturaIndex = musteri.fakturalar.findIndex(f => f.fakturaId === fakturaId);
            if(fakturaIndex === -1) return;
            
            const faktura = musteri.fakturalar[fakturaIndex];
            const ayIndex = parseInt(document.getElementById('modalOdenisAyIndex').value);
            const odenilenMebleg = parseFloat(document.getElementById('odenilenMebleg').value);
            const odenisUsulu = document.getElementById('odenisUsulu').value;

            const yeniOdenis = {
                id: "Q" + Date.now(),
                tarix: new Date().toISOString(),
                mebleg: odenilenMebleg,
                usul: odenisUsulu
            };
            
            if(odenisUsulu === 'Kart/Nağd') {
                const kartMebleg = parseFloat(document.getElementById('odenisKartMebleg').value) || 0;
                const nagdMebleg = parseFloat(document.getElementById('odenisNagdMebleg').value) || 0;
                if(Math.abs((kartMebleg + nagdMebleg) - odenilenMebleg) > 0.01){
                    alert('Kart və nağd məbləğlərin cəmi ümumi məbləğə bərabər deyil!');
                    return;
                }
                yeniOdenis.meblegKart = kartMebleg;
                yeniOdenis.meblegNagd = nagdMebleg;
                yeniOdenis.usulText = `Kart (${kartMebleg.toFixed(2)}) + Nağd (${nagdMebleg.toFixed(2)})`;
            }

            if(ayIndex >= 0 && ayIndex < faktura.odenisQrafiki.length) {
                 if (!faktura.odenisQrafiki[ayIndex].odenisler) {
                    faktura.odenisQrafiki[ayIndex].odenisler = [];
                }
                faktura.odenisQrafiki[ayIndex].odenisler.push(yeniOdenis);
            }
            
            recalculatePaymentScheduleForFaktura(faktura);
            
            musteriler[musteriIndex].fakturalar[fakturaIndex] = faktura;

            saveAndRender();
            odenisModal.style.display = 'none';
            openCekModal(musteri, faktura, yeniOdenis);
        }

        function calculateKreditDetails() {
            const nagdQiymet = parseFloat(nagdQiymetInput.value) || 0;
            const muddet = parseInt(kreditMuddetiSelect.value);
            const ilkinOdenis = parseFloat(ilkinOdenisInput.value) || 0;

            if (nagdQiymet > 0) {
                const faiz = interestRates[muddet];
                const kreditQiymeti = nagdQiymet * (1 + faiz);
                kreditQiymetiInput.value = kreditQiymeti.toFixed(2);

                const qaliqBorc = kreditQiymeti - ilkinOdenis;
                if (qaliqBorc > 0 && muddet > 0) {
                    const ayliqOdenis = qaliqBorc / muddet;
                    ayliqOdenisInput.value = ayliqOdenis.toFixed(2);
                } else {
                     ayliqOdenisInput.value = '0.00';
                }
            } else {
                kreditQiymetiInput.value = '';
                ayliqOdenisInput.value = '';
            }
        }
        
        function handleTableActions(e) {
            const target = e.target;
            const tr = target.closest('tr');
            if (!tr) return;
            
            const id = parseInt(tr.dataset.id);
            const fakturaId = tr.dataset.fakturaId;
            const musteri = musteriler.find(m => m.id === id);
            if (!musteri) return;
            
            let faktura = null;
            if(fakturaId) {
                faktura = musteri.fakturalar.find(f => f.fakturaId === fakturaId);
            }

            if (target.closest('.details-btn')) {
                if (faktura && faktura.tip === 'kredit') {
                    openOdenisTarixcesiModal(id, fakturaId, false);
                } else {
                     alert('Bu faktura üçün ödəniş cədvəli yoxdur.');
                }
            }
            if (target.closest('.edit-btn')) openEditModal(id);
            if (target.closest('.view-details-btn')) openDetailsModal(id);
            
            if (target.closest('.delete-btn')) {
                 const password = prompt("Müştərini silmək üçün şifrəni daxil edin:");
                 if (password === passwords.delete) {
                    showConfirm('Silmə Əməliyyatı', 'Bu müştərini və bütün məlumatlarını silməyə əminsiniz?', () => {
                        musteriler = musteriler.filter(m => m.id !== id);
                        saveAndRender();
                    });
                 } else if (password !== null) {
                     alert("Şifrə yanlışdır! Silmə əməliyyatı ləğv edildi.");
                 }
            }

            if (target.closest('.pay-btn')) {
                 if (faktura && faktura.tip === 'kredit') {
                    const novbetiOdenisAyIndex = faktura.odenisQrafiki.findIndex(ay => (ay.odenmeli - ay.odenmis) > 0.01);
                    if (novbetiOdenisAyIndex !== -1) {
                        openOdenisModal(id, fakturaId, novbetiOdenisAyIndex);
                    } else {
                        alert('Bu kredit fakturası üzrə aktiv borc yoxdur.');
                    }
                } else if(musteri) {
                    const ilkAktivKredit = musteri.fakturalar.find(f => f.tip === 'kredit' && getFakturaQaliqBorc(f) > 0.01);
                    if(ilkAktivKredit){
                         const novbetiOdenisAyIndex = ilkAktivKredit.odenisQrafiki.findIndex(ay => (ay.odenmeli - ay.odenmis) > 0.01);
                         if (novbetiOdenisAyIndex !== -1) {
                            openOdenisModal(id, ilkAktivKredit.fakturaId, novbetiOdenisAyIndex);
                         } else { alert('Müştərinin aktiv borcu yoxdur.'); }
                    } else { alert('Müştərinin aktiv kredit borcu yoxdur.'); }
                }
            }
        }
        
        function handleFakturaTarixcesiActions(e) {
             const target = e.target.closest('button');
             if(!target) return;
             const musteriId = parseInt(target.dataset.musteriId);
             const fakturaId = target.dataset.fakturaId;
             
             if(target.classList.contains('details-btn')) {
                 openOdenisTarixcesiModal(musteriId, fakturaId, false);
             }
             if(target.classList.contains('print-receipt-btn')) {
                 const musteri = musteriler.find(m => m.id === musteriId);
                 const faktura = musteri.fakturalar.find(f => f.fakturaId === fakturaId);
                 if(faktura) openNagdCekModal(musteri, faktura);
             }
        }

        function handleTarixceActions(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const musteriId = parseInt(target.dataset.musteriId);
            const fakturaId = target.dataset.fakturaId;
            
            if(target.classList.contains('edit-payment-btn')) {
                const odenisId = target.dataset.odenisId;
                handleEditPayment(musteriId, fakturaId, odenisId);
            }
            if(target.classList.contains('print-receipt-btn')) {
                const odenisId = target.dataset.odenisId;
                const musteri = musteriler.find(m => m.id === musteriId);
                const faktura = musteri.fakturalar.find(f => f.fakturaId === fakturaId);
                const odenis = faktura.odenisQrafiki.flatMap(ay => ay.odenisler || []).find(o => o.id === odenisId);
                if(odenis) openCekModal(musteri, faktura, odenis);
            }
        }

        function handleEditPayment(musteriId, fakturaId, odenisId) {
             const password = prompt("Düzəliş etmək üçün şifrəni daxil edin:");
             if (password !== passwords.edit) {
                 if (password !== null) alert("Şifrə yanlışdır! Düzəliş ləğv edildi.");
                 return;
             }

             const musteriIndex = musteriler.findIndex(m => m.id === musteriId);
             if(musteriIndex === -1) return;
             const musteri = musteriler[musteriIndex];
             const fakturaIndex = musteri.fakturalar.findIndex(f => f.fakturaId === fakturaId);
             if(fakturaIndex === -1) return;
             const faktura = musteri.fakturalar[fakturaIndex];
             
             let odenis, odenisAyi, odenisIndex;

             for (const ay of faktura.odenisQrafiki) {
                 const index = (ay.odenisler || []).findIndex(o => o.id === odenisId);
                 if (index !== -1) {
                     odenis = ay.odenisler[index];
                     odenisAyi = ay;
                     odenisIndex = index;
                     break;
                 }
             }

             if (!odenis) return;

             const yeniMeblegStr = prompt("Ödəniş üçün yeni məbləği daxil edin:", odenis.mebleg);
             const yeniMebleg = parseFloat(yeniMeblegStr);

             if (yeniMeblegStr !== null && !isNaN(yeniMebleg) && yeniMebleg >= 0) {
                 odenis.mebleg = yeniMebleg;
                 if (yeniMebleg === 0) {
                     odenisAyi.odenisler.splice(odenisIndex, 1);
                 }
                 
                 recalculatePaymentScheduleForFaktura(faktura);
                 musteriler[musteriIndex].fakturalar[fakturaIndex] = faktura;
                 saveAndRender();
                 openOdenisTarixcesiModal(musteriId, fakturaId, false);
             } else if (yeniMeblegStr !== null) {
                 alert("Düzgün məbləğ daxil edilməyib.");
             }
        }
        
        function handleSort(e) {
            const th = e.currentTarget;
            const column = th.dataset.sort;
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }
            renderMusteriler();
        }

        function openOdenisModal(musteriId, fakturaId, ayIndex) {
            const musteri = musteriler.find(m => m.id === musteriId);
            const faktura = musteri.fakturalar.find(f => f.fakturaId === fakturaId);
            const odenisAyi = faktura.odenisQrafiki[ayIndex];
            const qaliq = odenisAyi.odenmeli - odenisAyi.odenmis;

            if (!musteri || qaliq <= 0) {
                alert("Bu ay üçün borc yoxdur və ya tam ödənilib.");
                return;
            };

            document.getElementById('modalMusteriAdi').textContent = getFullName(musteri);
            document.getElementById('modalMehsulAdi').textContent = faktura.mehsulAdi;
            document.getElementById('modalAyliqOdenis').textContent = qaliq.toFixed(2);
            document.getElementById('odenilenMebleg').value = qaliq.toFixed(2);
            document.getElementById('modalMusteriId').value = musteriId;
            document.getElementById('modalFakturaId').value = fakturaId;
            document.getElementById('modalOdenisAyIndex').value = ayIndex;
            
            document.getElementById('odenisUsulu').value = 'Nağd';
            document.getElementById('mixedPaymentDiv').style.display = 'none';
            document.getElementById('odenilenMebleg').readOnly = false;
            document.getElementById('odenisKartMebleg').value = 0;
            document.getElementById('odenisNagdMebleg').value = 0;
            
            odenisModal.style.display = 'block';
        }

        function openOdenisTarixcesiModal(musteriId, fakturaId, isSimpleView = false) {
            const musteri = musteriler.find(m => m.id === musteriId);
            const faktura = musteri.fakturalar.find(f => f.fakturaId === fakturaId);

            if (!musteri || !faktura || faktura.tip !== 'kredit') {
                 alert("Bu faktura üçün kredit ödəniş qrafiki yoxdur.");
                return;
            }

            document.getElementById('tarixceMusteriAdi').textContent = `${getFullName(musteri)} (${musteri.musteriKodu})`;
            document.getElementById('tarixceMehsulAdi').textContent = faktura.mehsulAdi;
            const thead = document.getElementById('tarixceCedveliHead');
            const tbody = document.getElementById('tarixceCedveliBody');
            const modalTitle = document.getElementById('tarixceModalTitle');
            const printBtn = document.getElementById('tarixce-print-btn');

            tbody.innerHTML = '';
            
            if (isSimpleView) {
                modalTitle.innerHTML = '<i class="fas fa-calendar-alt"></i> Ödəniş Cədvəli';
                thead.innerHTML = '<th>№</th><th>Ödəniş Tarixi</th><th>Aylıq Məbləğ</th><th>Status</th>';
                printBtn.style.display = 'inline-block';
            } else {
                modalTitle.innerHTML = '<i class="fas fa-history"></i> Ödəniş Qrafiki';
                thead.innerHTML = '<th>№</th><th>Ödəniş Tarixi</th><th>Aylıq Məbləğ</th><th>Ödənilib</th><th>Qalıq</th><th>Status</th>';
                printBtn.style.display = 'none';
            }

            faktura.odenisQrafiki.forEach((ay, index) => {
                const qaliq = ay.odenmeli - ay.odenmis;
                let statusText, statusClass;

                if (qaliq <= 0.01) {
                    statusText = "Ödənilib";
                    statusClass = "paid-row";
                } else if (ay.odenmis > 0) {
                    statusText = "Qismən Ödənilib";
                    statusClass = "partially-paid-row";
                } else {
                    statusText = getStatus(ay.tarix).statusText;
                    statusClass = '';
                }
                
                const tr = document.createElement('tr');
                tr.className = statusClass;
                
                if (isSimpleView) {
                     tr.innerHTML = `
                        <td>${ay.ay}</td>
                        <td>${new Date(ay.tarix).toLocaleDateString('az-AZ')}</td>
                        <td>${ay.odenmeli.toFixed(2)}</td>
                        <td>${statusText}</td>
                    `;
                } else {
                    let odenisDetallari = '';
                    const allOdenisler = ay.odenisler || [];
                    if(allOdenisler.length > 0){
                        odenisDetallari += '<ul>';
                        allOdenisler.forEach(o => {
                            const meblegText = o.usul === 'Kart/Nağd' 
                                ? `<b>${o.mebleg.toFixed(2)} AZN</b> (K:${o.meblegKart.toFixed(2)}, N:${o.meblegNagd.toFixed(2)})`
                                : `<b>${o.mebleg.toFixed(2)} AZN</b>`;
                            odenisDetallari += `
                                <li>
                                    ${new Date(o.tarix).toLocaleDateString('az-AZ')} - ${meblegText}
                                    <div style="float: right;">
                                        <button class="action-btn edit-btn edit-payment-btn" data-musteri-id="${musteriId}" data-faktura-id="${fakturaId}" data-odenis-id="${o.id}" title="Düzəliş et"><i class="fas fa-edit"></i></button>
                                        <button class="action-btn print-receipt-btn" data-musteri-id="${musteriId}" data-faktura-id="${fakturaId}" data-odenis-id="${o.id}" title="Çeki çap et"><i class="fas fa-print"></i></button>
                                    </div>
                                </li>`;
                        });
                        odenisDetallari += '</ul>';
                    } else {
                         odenisDetallari = ay.odenmis > 0 ? `${ay.odenmis.toFixed(2)} AZN (transfer)` : '---' ;
                    }
                    
                    tr.innerHTML = `
                        <td>${ay.ay}</td>
                        <td>${new Date(ay.tarix).toLocaleDateString('az-AZ')}</td>
                        <td>${ay.odenmeli.toFixed(2)}</td>
                        <td>${odenisDetallari}</td>
                        <td><b>${qaliq < 0 ? '0.00' : qaliq.toFixed(2)}</b></td>
                        <td>${statusText}</td>
                    `;
                }
                tbody.appendChild(tr);
            });
            odenisTarixcesiModal.style.display = 'block';
        }

        function openDetailsModal(id) {
            const musteri = musteriler.find(m => m.id === id);
            if (!musteri) return;
            
            document.getElementById('detailsMusteriKodu').textContent = musteri.musteriKodu || '---';
            document.getElementById('detailsAdSoyad').textContent = getFullName(musteri);
            document.getElementById('detailsCins').textContent = musteri.cins || '---';
            document.getElementById('detailsFinKod').textContent = musteri.finKod || '---';
            document.getElementById('detailsVesiqe').textContent = musteri.vesiqeSeria || '---';
            document.getElementById('detailsNomreler').textContent = (musteri.nomreler || []).join(', ');
            
            const tbody = document.getElementById('fakturaTarixcesiBody');
            tbody.innerHTML = '';

            if (musteri.fakturalar && musteri.fakturalar.length > 0) {
                musteri.fakturalar.forEach(faktura => {
                    let meblegInfo = '';
                    let emeliyyatBtn = '';

                    if (faktura.tip === 'kredit') {
                        const qaliqBorc = getFakturaQaliqBorc(faktura);
                        meblegInfo = `Qalıq: <b>${qaliqBorc.toFixed(2)} AZN</b>`;
                        emeliyyatBtn = `<button class="action-btn details-btn" data-musteri-id="${id}" data-faktura-id="${faktura.fakturaId}">Cədvələ Bax</button>`;
                    } else {
                        meblegInfo = `${faktura.mebleg.toFixed(2)} AZN`;
                        emeliyyatBtn = `<button class="action-btn print-receipt-btn" data-musteri-id="${id}" data-faktura-id="${faktura.fakturaId}"><i class="fas fa-print"></i> Qəbz</button>`;
                    }

                    const tr = `
                        <tr>
                            <td>${faktura.fakturaId}</td>
                            <td>${new Date(faktura.tarix).toLocaleDateString('az-AZ')}</td>
                            <td><span class="status-indicator ${faktura.tip === 'kredit' ? 'status-kredit' : 'status-nagd'}"></span> ${faktura.tip.toUpperCase()}</td>
                            <td>${faktura.mehsulAdi || faktura.mehsul}</td>
                            <td>${meblegInfo}</td>
                            <td>${emeliyyatBtn}</td>
                        </tr>`;
                    tbody.innerHTML += tr;
                });
            } else {
                 tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Müştərinin faktura tarixçəsi boşdur.</td></tr>';
            }
            
            detailsModal.style.display = 'block';
        }
        
        function openEditModal(id) {
            const musteri = musteriler.find(m => m.id === id);
            if (!musteri) return;
            
            document.getElementById('editMusteriId').value = musteri.id;
            document.getElementById('editAd').value = musteri.ad;
            document.getElementById('editSoyad').value = musteri.soyad;
            document.getElementById('editAtaAdi').value = musteri.ataAdi;
            document.getElementById('editCins').value = musteri.cins || 'Kişi';
            document.getElementById('editFinKod').value = musteri.finKod;
            const [seria, ...nomreParts] = (musteri.vesiqeSeria || '').split(' ');
            const nomre = nomreParts.join('');
            document.getElementById('editVesiqeSeria').value = seria || 'AZE';
            document.getElementById('editVesiqeNomre').value = nomre || '';
            
            document.getElementById('editMobil1').value = (musteri.nomreler || [])[0] || '';
            document.getElementById('editMobil2').value = (musteri.nomreler || [])[1] || '';
            document.getElementById('editMobil3').value = (musteri.nomreler || [])[2] || '';
            
            editModal.style.display = 'block';
        }

        function openCekModal(musteri, faktura, odenis) {
            document.getElementById('cekSatici').textContent = magazaAdi;
            document.getElementById('cekId').textContent = odenis.id;
            document.getElementById('cekTarix').textContent = new Date(odenis.tarix).toLocaleString('az-AZ');
            document.getElementById('cekMusteriAdi').textContent = `${getFullName(musteri)} (${musteri.musteriKodu})`;
            document.getElementById('cekMehsulAdi').textContent = faktura.mehsulAdi;
            document.getElementById('cekOdenenMebleg').textContent = odenis.mebleg.toFixed(2);
            document.getElementById('cekOdenisUsulu').textContent = odenis.usulText || odenis.usul;
            document.getElementById('cekFakturaQaliqBorc').textContent = Math.max(0, getFakturaQaliqBorc(faktura)).toFixed(2);
            document.getElementById('cekUmumiQaliqBorc').textContent = Math.max(0, getMusteriUmumiQaliqBorc(musteri)).toFixed(2);
            cekModal.style.display = 'block';
        }
        
        function openMuqavileModal(data) {
            const { customer, faktura } = data;
            document.getElementById('muqavileSatici').textContent = magazaAdi;
            document.getElementById('muqavileTarix').textContent = new Date(faktura.tarix).toLocaleDateString('az-AZ');
            document.getElementById('muqavileMusteriAdi').textContent = getFullName(customer);
            document.getElementById('muqavileMusteriKodu').textContent = customer.musteriKodu;
            document.getElementById('muqavileFinKod').textContent = customer.finKod;
            document.getElementById('muqavileVesiqe').textContent = customer.vesiqeSeria;
            document.getElementById('muqavileMehsul').textContent = faktura.mehsulAdi;
            document.getElementById('muqavileKateqoriya').textContent = faktura.mehsulKateqoriya;
            document.getElementById('muqavileNagdQiymet').textContent = faktura.nagdQiymet.toFixed(2);
            document.getElementById('muqavileKreditQiymeti').textContent = faktura.kreditQiymeti.toFixed(2);
            document.getElementById('muqavileIlkinOdenis').textContent = faktura.ilkinOdenis.toFixed(2);
            document.getElementById('muqavileKreditMuddeti').textContent = faktura.kreditMuddeti;
            const ayliq = faktura.odenisQrafiki[0].odenmeli;
            document.getElementById('muqavileAyliqOdenis').textContent = ayliq.toFixed(2);
            document.getElementById('muqavileIlkOdenisTarixi').textContent = new Date(faktura.odenisQrafiki[0].tarix).toLocaleDateString('az-AZ');
            
            const qrafikBody = document.getElementById('muqavileQrafikBody');
            qrafikBody.innerHTML = '';
            
            faktura.odenisQrafiki.forEach(ay => {
                 qrafikBody.innerHTML += `
                    <tr>
                        <td>${ay.ay}</td>
                        <td>${new Date(ay.tarix).toLocaleDateString('az-AZ')}</td>
                        <td>${ay.odenmeli.toFixed(2)}</td>
                        <td>Gözləmədə</td>
                    </tr>
                `;
            });
            
            muqavileModal.style.display = 'block';
        }

        function saveAndRender() {
            localStorage.setItem('musteriler', JSON.stringify(musteriler));
            updateDashboard();
            renderMusteriler();
        }

        function getFakturaQaliqBorc(faktura) {
             if (!faktura || faktura.tip !== 'kredit') return 0;
             const umumiBorc = faktura.odenisQrafiki.reduce((acc, curr) => acc + curr.odenmeli, 0);
             const umumiOdenilmis = faktura.odenisQrafiki.reduce((acc, curr) => acc + curr.odenmis, 0);
             return umumiBorc - umumiOdenilmis;
        }
        
        function getMusteriUmumiQaliqBorc(musteri) {
            if (!musteri.fakturalar || musteri.fakturalar.length === 0) return 0;
            return musteri.fakturalar.reduce((total, faktura) => {
                return total + getFakturaQaliqBorc(faktura);
            }, 0);
        }

        function updateDashboard() {
            const aktivMusteriler = musteriler.filter(m => getMusteriUmumiQaliqBorc(m) > 0.01);
            
            document.getElementById('total-customers').textContent = aktivMusteriler.length;
            
            const totalDebt = aktivMusteriler.reduce((acc, m) => acc + getMusteriUmumiQaliqBorc(m), 0);
            document.getElementById('total-debt').textContent = `${Math.max(0, totalDebt).toFixed(2)} AZN`;

            const overdue = aktivMusteriler.filter(m => {
                return m.fakturalar.some(f => {
                    if (f.tip !== 'kredit') return false;
                    const novbetiOdenisAyi = f.odenisQrafiki.find(ay => (ay.odenmeli - ay.odenmis) > 0.01);
                    return novbetiOdenisAyi && getStatus(novbetiOdenisAyi.tarix).statusCode < 0;
                });
            }).length;
            document.getElementById('overdue-payments').textContent = overdue;

            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const paidThisMonth = musteriler.reduce((total, m) => {
                if (!m.fakturalar) return total;
                
                const buAyOdenisleri = m.fakturalar.reduce((fakturaTotal, f) => {
                    if (f.tip === 'kredit') {
                        const kreditOdenisleri = f.odenisQrafiki
                            .flatMap(ay => ay.odenisler || [])
                            .filter(o => {
                                const oDate = new Date(o.tarix);
                                return oDate.getMonth() === thisMonth && oDate.getFullYear() === thisYear;
                            })
                            .reduce((sum, o) => sum + o.mebleg, 0);
                        return fakturaTotal + kreditOdenisleri;
                    } else if (f.tip === 'nagd') {
                        const sDate = new Date(f.tarix);
                        if (sDate.getMonth() === thisMonth && sDate.getFullYear() === thisYear) {
                            return fakturaTotal + f.mebleg;
                        }
                    }
                    return fakturaTotal;
                }, 0);
                
                return total + buAyOdenisleri;
            }, 0);

            document.getElementById('paid-this-month').textContent = `${paidThisMonth.toFixed(2)} AZN`;
        }
        
        function renderMusteriler() {
            const searchTerm = searchBox.value.toLowerCase();
            let filteredMusteriler = musteriler.filter(m => 
                 (getFullName(m).toLowerCase().includes(searchTerm)) ||
                 (m.musteriKodu && m.musteriKodu.toLowerCase().includes(searchTerm)) ||
                 (m.finKod && m.finKod.toLowerCase().includes(searchTerm))
            );
            
            const processedMusteriler = filteredMusteriler.map(m => {
                const umumiQaliqBorc = getMusteriUmumiQaliqBorc(m);
                const aktivKreditler = (m.fakturalar || []).filter(f => f.tip === 'kredit' && getFakturaQaliqBorc(f) > 0.01);
                
                let enYaxinOdenis = null;
                if (aktivKreditler.length > 0) {
                    aktivKreditler.forEach(f => {
                        const novbetiOdenisAyi = f.odenisQrafiki.find(ay => (ay.odenmeli - ay.odenmis) > 0.01);
                        if (novbetiOdenisAyi) {
                            const odenisTarixi = new Date(novbetiOdenisAyi.tarix);
                            if (!enYaxinOdenis || odenisTarixi < new Date(enYaxinOdenis.tarix)) {
                                enYaxinOdenis = {
                                    tarix: novbetiOdenisAyi.tarix,
                                    mebleg: novbetiOdenisAyi.odenmeli - novbetiOdenisAyi.odenmis
                                };
                            }
                        }
                    });
                }
                
                return {
                    ...m,
                    qaliqBorc: umumiQaliqBorc,
                    novbetiOdenisTarixi: enYaxinOdenis ? enYaxinOdenis.tarix : '---',
                    ayliqOdenis: enYaxinOdenis ? enYaxinOdenis.mebleg : 0,
                    status: enYaxinOdenis ? getStatus(enYaxinOdenis.tarix).statusCode : (umumiQaliqBorc > 0.01 ? 3 : 4)
                };
            });

            if (sortState.column) {
                processedMusteriler.sort((a, b) => {
                    let valA = a[sortState.column];
                    let valB = b[sortState.column];
                    
                    if (typeof valA === 'string' && sortState.column !== 'novbetiOdenisTarixi') {
                        valA = valA.toLowerCase(); valB = valB.toLowerCase();
                    }
                     if (sortState.column === 'novbetiOdenisTarixi') {
                        valA = valA === '---' ? new Date('9999-12-31') : new Date(valA);
                        valB = valB === '---' ? new Date('9999-12-31') : new Date(valB);
                    }

                    if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            tableHeaders.forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                if (icon) {
                    icon.className = 'fas fa-sort sort-icon';
                    if (th.dataset.sort === sortState.column) {
                        th.classList.add('sorted');
                        icon.className = `fas fa-sort-${sortState.direction === 'asc' ? 'up' : 'down'} sort-icon`;
                    }
                }
            });
            
            musteriCedveli.innerHTML = processedMusteriler.map(musteri => {
                const hasActiveCredit = musteri.qaliqBorc > 0.01;
                let statusClass = getStatus(musteri.novbetiOdenisTarixi).statusClass;
                let novbetiTarix = musteri.novbetiOdenisTarixi !== '---' 
                    ? new Date(musteri.novbetiOdenisTarixi).toLocaleDateString('az-AZ') 
                    : (hasActiveCredit ? 'Bitib' : '---');

                if (!hasActiveCredit && (musteri.fakturalar || []).some(f => f.tip === 'nagd')) {
                    statusClass = 'status-nagd';
                }

                 return `
                    <tr data-id="${musteri.id}">
                        <td><span class="status-indicator ${statusClass}" title="${getStatus(musteri.novbetiOdenisTarixi).statusText}"></span></td>
                        <td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td>
                        <td>${hasActiveCredit ? Math.max(0, musteri.ayliqOdenis).toFixed(2) + ' AZN' : '---'}</td>
                        <td>${hasActiveCredit ? Math.max(0, musteri.qaliqBorc).toFixed(2) + ' AZN' : '---'}</td>
                        <td>${novbetiTarix}</td>
                        <td>
                            ${hasActiveCredit ? '<button class="action-btn pay-btn" title="Ödəniş et"><i class="fas fa-dollar-sign"></i></button>' : ''}
                            <button class="action-btn view-details-btn" title="Bax"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit-btn" title="Düzəliş et"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" title="Sil"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (processedMusteriler.length === 0) {
                musteriCedveli.innerHTML = `<tr><td colspan="6" style="text-align:center;">Müştəri tapılmadı.</td></tr>`;
            }
        }
        
        function getStatus(novbetiOdenis) {
            if (!novbetiOdenis || novbetiOdenis === '---') return { statusClass: 'status-normal', statusCode: 3, statusText: 'Normal' };
            const buGun = new Date();
            const odenisTarixi = new Date(novbetiOdenis);
            buGun.setHours(0,0,0,0);
            odenisTarixi.setHours(0,0,0,0);

            const ferqGun = Math.ceil((odenisTarixi - buGun) / (1000 * 3600 * 24));
            
            if (ferqGun < 0) return { statusClass: 'status-gecikir', statusCode: -1, statusText: 'Gecikir' };
            if (ferqGun === 0) return { statusClass: 'status-bugun', statusCode: 0, statusText: 'Bu gün' };
            if (ferqGun <= 5) return { statusClass: 'status-yaxinlasir', statusCode: 1, statusText: 'Yaxınlaşır' };
            return { statusClass: 'status-normal', statusCode: 2, statusText: 'Normal' };
        }

        // Başlanğıc funksiyaları
        migrateData(); // Databazanı yoxla və yenilə
        calculateKreditDetails();
        saveAndRender();
        toggleKreditFormRequired(false);
        magazaAdiInput.value = magazaAdi;
    });
    </script>
</body>
</html>
