<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kredit İdarəetmə Sistemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* CSS KODLARI BURADA BAŞLAYIR */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --danger-color: #d0021b;
            --success-color: #7ed321;
            --info-color: #4abde2;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --background-color: #f4f7f6;
            --text-color: #333;
            --border-color: #ddd;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--dark-color); color: var(--light-color); padding: 20px 0; display: flex; flex-direction: column; }
        .sidebar-header { text-align: center; margin-bottom: 30px; padding: 0 15px; }
        .sidebar-header h3 { font-weight: 600; }
        .nav-menu { list-style: none; flex-grow: 1; }
        .nav-item a { display: block; padding: 15px 25px; color: var(--light-color); text-decoration: none; transition: background-color 0.3s, padding-left 0.3s; border-left: 3px solid transparent; }
        .nav-item.active a, .nav-item a:hover { background-color: var(--primary-color); border-left-color: var(--secondary-color); }
        .nav-item i { margin-right: 15px; width: 20px; text-align: center; }
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .main-header h1 { margin-bottom: 0; }
        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1, h2 { color: var(--dark-color); margin-bottom: 20px; }
        h1 i, h2 i { color: var(--primary-color); }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; }
        .card .icon { font-size: 2.5rem; margin-right: 20px; padding: 15px; border-radius: 50%; color: #fff; }
        .card.card-customers .icon { background-color: var(--primary-color); }
        .card.card-debt .icon { background-color: var(--danger-color); }
        .card.card-overdue .icon { background-color: var(--secondary-color); }
        .card.card-paid .icon { background-color: var(--success-color); }
        .card .info h3 { font-size: 2rem; color: var(--dark-color); }
        .card .info p { font-size: 0.9rem; color: #777; }
        form { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .form-section-title { font-weight: 600; color: var(--primary-color); margin-top: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 15px; }
        .form-row.form-row-condensed { grid-template-columns: 2fr 1fr 1.2fr; }
        .form-group { display: flex; flex-direction: column; }
        .input-group { display: flex; align-items: center; gap: 5px; }
        .input-group select { flex: 0 0 80px; }
        .input-group input { flex: 1; }
        .form-group label { margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; background-color: #fff; }
        .form-group input:read-only { background-color: #f1f1f1; cursor: not-allowed; font-weight: bold; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 5px rgba(74, 144, 226, 0.5); }
        .submit-btn { background-color: var(--primary-color); color: #fff; border: none; padding: 12px 25px; font-size: 16px; font-weight: 600; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; margin-top: 10px; }
        .submit-btn:hover { background-color: #3a7ac8; transform: translateY(-2px); }
        .export-btn { background-color: var(--success-color); }
        .export-btn:hover { background-color: #69b31c; }
        #searchBox { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 16px; }
        .table-container { background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        thead { background-color: #f8f9fa; }
        th { font-weight: 600; color: var(--dark-color); user-select: none; }
        th[data-sort] { cursor: pointer; }
        th .sort-icon { margin-left: 5px; opacity: 0.5; }
        th.sorted .sort-icon { opacity: 1; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; }
        .status-gecikir, .status-qismen { background-color: var(--danger-color); }
        .status-bugun { background-color: var(--secondary-color); }
        .status-yaxinlasir { background-color: var(--success-color); }
        .status-normal { background-color: #ccc; }
        .status-odenilib { background-color: var(--success-color); }
        .action-btn { background: none; padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; color: #fff; margin: 0 2px; font-size: 13px; transition: opacity 0.3s; }
        .action-btn:hover { opacity: 0.8; }
        .pay-btn { background-color: var(--primary-color); }
        .edit-btn { background-color: var(--secondary-color); }
        .delete-btn { background-color: var(--danger-color); }
        .details-btn { background-color: var(--info-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 700px; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.2); animation: slideIn 0.4s; }
        .modal-content.modal-sm { max-width: 500px; }
        .modal-content.modal-lg { max-width: 800px; }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; }
        .printable-content { border: 1px dashed #333; padding: 20px; margin-bottom: 20px; }
        .printable-content h2 { text-align: center; margin-bottom: 15px; }
        .printable-content p { margin-bottom: 10px; font-size: 16px; }
        .printable-content hr { margin: 15px 0; }
        #muqavileBody .muqavile-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        #qrafikCedveli { width: 100%; margin-top: 15px; border-collapse: collapse; }
        #qrafikCedveli th, #qrafikCedveli td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        #qrafikCedveli thead { background-color: #f2f2f2; }
        .modal-actions { text-align: right; margin-top: 20px; }
        .modal-actions .submit-btn { margin-left: 10px; }
        #tarixceCedveli th, #tarixceCedveli td { padding: 8px; font-size: 0.9rem; }
        #tarixceCedveli .action-btn { color: var(--dark-color); }
        @media print {
            body * { visibility: hidden; }
            .printable-modal, .printable-modal *, .printable-content, .printable-content * { visibility: visible; }
            .printable-modal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; margin: 0; padding: 0; background: none; overflow: visible !important; }
            .modal-content { box-shadow: none; border: none; margin: 0; max-width: 100%; padding: 5px; }
            .modal-actions, .close-btn { display: none; }
            #muqavileBody, #muqavileBody p { font-size: 10pt; line-height: 1.4; }
            #muqavileBody h2 { font-size: 14pt; }
            #muqavileBody h3 { font-size: 11pt; margin-top: 10px; }
            #qrafikCedveli th, #qrafikCedveli td { padding: 4px; font-size: 9pt; }
        }
    </style>
</head>
<body>

    <div class="container">
        <nav class="sidebar"></nav>
        <main class="main-content"></main>
    </div>
    
    <div id="odenisModal" class="modal"><div class="modal-content modal-sm"><span class="close-btn" id="closeOdenisModal">&times;</span><h2><i class="fas fa-wallet"></i> Ödəniş Et</h2><form id="odenisFormu"><p><strong>Müştəri:</strong> <span id="modalMusteriAdi"></span></p><p><strong>Aylıq Ödəniş Təxmini:</strong> <span id="modalAyliqOdenis"></span> AZN</p><input type="hidden" id="modalMusteriId"><div class="form-group"><label for="odenilenMebleg">Ödənilən Məbləğ (AZN)</label><input type="number" id="odenilenMebleg" step="0.01" required></div><div class="form-group"><label for="odenisUsulu">Ödəniş Üsulu</label><select id="odenisUsulu"><option value="Nağd">Nağd</option><option value="Kart">Kart ilə</option></select></div><button type="submit" class="submit-btn"><i class="fas fa-dollar-sign"></i> Ödənişi Təsdiqlə</button></form></div></div>
    
    <div id="cekModal" class="modal printable-modal"><div class="modal-content modal-sm" id="cekContent"><span class="close-btn" id="closeCekModal">&times;</span><div id="cekBody" class="printable-content"><h2>ÖDƏNİŞ QƏBZİ</h2><p><strong>Tarix:</strong> <span id="cekTarix"></span></p><hr><p><strong>Müştəri:</strong> <span id="cekMusteriAdi"></span></p><p><strong>Ödənilən Məbləğ:</strong> <span id="cekOdenenMebleg"></span> AZN</p><p><strong>Ödəniş Üsulu:</strong> <span id="cekOdenisUsulu"></span></p><hr><p><strong>Ümumi Qalıq Borc:</strong> <span id="cekQaliqBorc"></span> AZN</p><p><strong>Qalıq Ödəniş Sayı:</strong> <span id="cekQaliqAylar"></span></p></div><div class="modal-actions"><button id="printCekBtn" class="submit-btn"><i class="fas fa-print"></i> Çap Et</button></div></div></div>
    
    <div id="editModal" class="modal"><div class="modal-content modal-lg"></div></div>

    <div id="muqavileModal" class="modal printable-modal"><div class="modal-content modal-lg"></div></div>
    
    <div id="odenisTarixcesiModal" class="modal"><div class="modal-content modal-lg"><span class="close-btn" id="closeTarixceModal">&times;</span><h2><i class="fas fa-history"></i> Ödəniş Tarixçəsi və Cədvəli</h2><p><strong>Müştəri:</strong> <span id="tarixceMusteriAdi"></span></p><div class="table-container"><table id="tarixceCedveli"><thead><tr><th>№</th><th>Ödəniş Tarixi</th><th>Plan (AZN)</th><th>Ödənilib (AZN)</th><th>Qalıq (AZN)</th><th>Status</th><th>Əməliyyatlar</th></tr></thead><tbody id="tarixceCedveliBody"></tbody></table></div></div></div>

    <div id="editOdenisModal" class="modal"><div class="modal-content modal-sm"><span class="close-btn" id="closeEditOdenisModal">&times;</span><h2><i class="fas fa-pencil-alt"></i> Ödənişə Düzəliş Et</h2><form id="editOdenisFormu"><input type="hidden" id="editOdenisMusteriId"><input type="hidden" id="editOdenisTimestamp"><div class="form-group"><label for="editOdenisMebleg">Məbləğ (AZN)</label><input type="number" id="editOdenisMebleg" step="0.01" required></div><div class="form-group"><label for="editOdenisUsulu">Ödəniş Üsulu</label><select id="editOdenisUsulu"><option value="Nağd">Nağd</option><option value="Kart">Kart ilə</option></select></div><button type="submit" class="submit-btn"><i class="fas fa-save"></i> Yadda Saxla</button></form></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // === ELEMENT SEÇİMLƏRİ ===
        // (Previous selections remain the same)
        const odenisTarixcesiModal = document.getElementById('odenisTarixcesiModal');
        const closeTarixceModal = document.getElementById('closeTarixceModal');
        const tarixceCedveliBody = document.getElementById('tarixceCedveliBody');
        const editOdenisModal = document.getElementById('editOdenisModal');
        const closeEditOdenisModal = document.getElementById('closeEditOdenisModal');
        const editOdenisFormu = document.getElementById('editOdenisFormu');

        // === QLOBAL DƏYİŞƏNLƏR ===
        // (Previous globals remain the same)

        // === HADİSƏ DİNLƏYİCİLƏRİ (EVENT LISTENERS) ===
        // (Previous listeners remain the same)

        odenisFormu.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('modalMusteriId').value);
            const musteri = musteriler.find(m => m.id === id);
            const odenilenMebleg = parseFloat(document.getElementById('odenilenMebleg').value);

            if (odenilenMebleg <= 0) {
                alert("Ödəniş məbləği 0-dan böyük olmalıdır.");
                return;
            }

            // YENİ: Ödənişi təsdiq etmək üçün soruş
            if (confirm(`${odenilenMebleg.toFixed(2)} AZN məbləğində ödənişi təsdiqləməyə əminsiniz?`)) {
                if (musteri.qaliqAylar <= 0) {
                    const umumiBorc = musteri.kreditQiymeti - musteri.ilkinOdenis;
                    const odenilmis = musteri.odenisTarixcesi.reduce((acc, curr) => acc + curr.mebleg, 0);
                    if (odenilmis >= umumiBorc) {
                        alert("Bu kredit artıq tamamilə ödənilib!");
                        return;
                    }
                }

                // Yeni ödənişin hansı aya aid olduğunu təyin et
                const odenisIndex = musteri.kreditMuddeti - musteri.qaliqAylar;

                const yeniOdenis = {
                    tarix: new Date().toISOString(), // Unikal ID kimi istifadə olunacaq
                    mebleg: odenilenMebleg,
                    usul: document.getElementById('odenisUsulu').value,
                    odenisIndex: odenisIndex // Hansı ayın ödənişi olduğunu qeyd edir
                };
                musteri.odenisTarixcesi.push(yeniOdenis);

                // Yalnız ödəniş edildikdən sonra qalıq ay sayını və növbəti tarixi yenilə
                musteri.qaliqAylar -= 1;
                const novbetiOdenis = new Date(musteri.novbetiOdenisTarixi);
                novbetiOdenis.setMonth(novbetiOdenis.getMonth() + 1);
                musteri.novbetiOdenisTarixi = novbetiOdenis.toISOString().split('T')[0];

                saveAndRender();
                odenisModal.style.display = 'none';
                openCekModal(musteri, yeniOdenis);
            }
        });
        
        editOdenisFormu.addEventListener('submit', (e) => {
            e.preventDefault();
            const musteriId = document.getElementById('editOdenisMusteriId').value;
            const odenisTimestamp = document.getElementById('editOdenisTimestamp').value;
            const yeniMebleg = parseFloat(document.getElementById('editOdenisMebleg').value);
            const yeniUsul = document.getElementById('editOdenisUsulu').value;

            const musteri = musteriler.find(m => m.id == musteriId);
            const odenis = musteri.odenisTarixcesi.find(o => o.tarix === odenisTimestamp);

            if(odenis && yeniMebleg > 0) {
                odenis.mebleg = yeniMebleg;
                odenis.usul = yeniUsul;
                saveAndRender();
                editOdenisModal.style.display = 'none';
                // Dəyişiklikdən sonra tarixçə pəncərəsini yenilə
                openOdenisTarixcesiModal(musteri.id);
            } else {
                alert("Məbləğ 0-dan böyük olmalıdır!");
            }
        });

        // Modal pəncərələri bağlamaq
        closeTarixceModal.onclick = () => odenisTarixcesiModal.style.display = 'none';
        closeEditOdenisModal.onclick = () => editOdenisModal.style.display = 'none';
        window.onclick = (event) => {
            // (Previous onclick logic)
            if (event.target == odenisTarixcesiModal) odenisTarixcesiModal.style.display = 'none';
            if (event.target == editOdenisModal) editOdenisModal.style.display = 'none';
        };
        
        // Tarixçə cədvəlindəki düymələr üçün event listener
        tarixceCedveliBody.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if(!target) return;
            
            const musteriId = target.dataset.musteriId;
            const odenisTimestamp = target.dataset.odenisTimestamp;
            
            if (target.classList.contains('edit-odenis-btn')) {
                openEditOdenisModal(musteriId, odenisTimestamp);
            }
            if (target.classList.contains('print-cek-btn')) {
                const musteri = musteriler.find(m => m.id == musteriId);
                const odenis = musteri.odenisTarixcesi.find(o => o.tarix === odenisTimestamp);
                if (musteri && odenis) {
                    openCekModal(musteri, odenis);
                }
            }
        });

        // === FUNKSİYALAR ===

        function handleTableActions(e) {
            // ... (previous logic for pay, edit, delete buttons)
            if (target.closest('.details-btn')) openOdenisTarixcesiModal(id);
        }

        // TAMAMILƏ YENİLƏNMİŞ FUNKSİYA
        function openOdenisTarixcesiModal(id) {
            const musteri = musteriler.find(m => m.id === id);
            if (!musteri) return;

            document.getElementById('tarixceMusteriAdi').textContent = musteri.adSoyadAta;
            tarixceCedveliBody.innerHTML = '';

            const planAyliq = (musteri.kreditQiymeti - musteri.ilkinOdenis) / musteri.kreditMuddeti;
            let odenisTarixi = new Date(musteri.novbetiOdenisTarixi);
            // Tarixi geriyə, ilk ödəniş tarixinə çəkirik
            const odenisSayi = musteri.kreditMuddeti - musteri.qaliqAylar;
            odenisTarixi.setMonth(odenisTarixi.getMonth() - odenisSayi);

            for (let i = 0; i < musteri.kreditMuddeti; i++) {
                // Bu aya aid olan bütün ödənişləri tapırıq
                const buAyinOdenisleri = musteri.odenisTarixcesi.filter(o => o.odenisIndex === i);
                const cemiOdenilib = buAyinOdenisleri.reduce((acc, curr) => acc + curr.mebleg, 0);
                const qaliq = planAyliq - cemiOdenilib;

                let statusText = '';
                let statusClass = '';
                let emeliyyatlarHTML = '';

                if (cemiOdenilib > 0) { // Əgər bu ay üçün hər hansı bir ödəniş edilibsə
                    if (qaliq <= 0.01) {
                        statusText = 'Ödənilib';
                        statusClass = 'status-odenilib';
                    } else {
                        statusText = 'Qismən Ödənilib';
                        statusClass = 'status-qismen';
                    }
                    // Yalnız son ödənişi redaktə etmək və çap etmək üçün
                    const sonOdenis = buAyinOdenisleri[buAyinOdenisleri.length - 1];
                    emeliyyatlarHTML = `
                        <button class="action-btn edit-odenis-btn" title="Düzəliş et" data-musteri-id="${id}" data-odenis-timestamp="${sonOdenis.tarix}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="action-btn print-cek-btn" title="Çeki çap et" data-musteri-id="${id}" data-odenis-timestamp="${sonOdenis.tarix}"><i class="fas fa-print"></i></button>
                    `;
                } else { // Heç bir ödəniş edilməyibsə
                    const buGun = new Date();
                    buGun.setHours(0,0,0,0);
                    if (odenisTarixi < buGun) {
                        statusText = 'Gecikir';
                        statusClass = 'status-gecikir';
                    } else {
                        statusText = 'Gözləmədə';
                        statusClass = 'status-normal';
                    }
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${odenisTarixi.toLocaleDateString('az-AZ')}</td>
                    <td>${planAyliq.toFixed(2)}</td>
                    <td>${cemiOdenilib.toFixed(2)}</td>
                    <td>${Math.max(0, qaliq).toFixed(2)}</td>
                    <td><span class="status-indicator ${statusClass}" title="${statusText}"></span> ${statusText}</td>
                    <td>${emeliyyatlarHTML}</td>
                `;
                tarixceCedveliBody.appendChild(tr);
                odenisTarixi.setMonth(odenisTarixi.getMonth() + 1);
            }
            odenisTarixcesiModal.style.display = 'block';
        }

        // YENİ FUNKSİYA
        function openEditOdenisModal(musteriId, odenisTimestamp) {
            const musteri = musteriler.find(m => m.id == musteriId);
            const odenis = musteri.odenisTarixcesi.find(o => o.tarix === odenisTimestamp);

            if (musteri && odenis) {
                document.getElementById('editOdenisMusteriId').value = musteriId;
                document.getElementById('editOdenisTimestamp').value = odenisTimestamp;
                document.getElementById('editOdenisMebleg').value = odenis.mebleg;
                document.getElementById('editOdenisUsulu').value = odenis.usul;
                editOdenisModal.style.display = 'block';
            }
        }
        
        // Cüzi Dəyişiklik Edilmiş Funksiya
        function openCekModal(musteri, odenis) {
            const umumiBorc = musteri.kreditQiymeti - musteri.ilkinOdenis;
            const odenilmis = musteri.odenisTarixcesi.reduce((acc, curr) => acc + curr.mebleg, 0);
            document.getElementById('cekTarix').textContent = new Date(odenis.tarix).toLocaleString('az-AZ');
            document.getElementById('cekMusteriAdi').textContent = musteri.adSoyadAta;
            document.getElementById('cekOdenenMebleg').textContent = odenis.mebleg.toFixed(2);
            document.getElementById('cekOdenisUsulu').textContent = odenis.usul;
            document.getElementById('cekQaliqBorc').textContent = Math.max(0, (umumiBorc - odenilmis)).toFixed(2);
            document.getElementById('cekQaliqAylar').textContent = musteri.qaliqAylar;
            cekModal.style.display = 'block';
        }

        // Proqram ilk açılanda ilkin funksiyaları işə sal
        // (No changes here)
        // ...
    });
    // JAVASCRIPT KODLARI BURADA BİTİR
    </script>
</body>
</html>
